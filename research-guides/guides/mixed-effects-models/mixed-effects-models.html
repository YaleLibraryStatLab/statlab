<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Cole Brookson">
<meta name="dcterms.date" content="2025-11-10">
<meta name="keywords" content="<p>mixed-effects models, hierarchical models, multilevel models, random effects, variance components, longitudinal data, clustered data, R, Julia, <code>lme4</code>, <code>MixedModels.jl</code></p>">

<title>Mixed-Effects Models: A Practical Guide</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="mixed-effects-models_files/libs/clipboard/clipboard.min.js"></script>
<script src="mixed-effects-models_files/libs/quarto-html/quarto.js"></script>
<script src="mixed-effects-models_files/libs/quarto-html/popper.min.js"></script>
<script src="mixed-effects-models_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="mixed-effects-models_files/libs/quarto-html/anchor.min.js"></script>
<link href="mixed-effects-models_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="mixed-effects-models_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="mixed-effects-models_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="mixed-effects-models_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="mixed-effects-models_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="mixed-effects-models_files/libs/quarto-diagram/mermaid.min.js"></script>
<script src="mixed-effects-models_files/libs/quarto-diagram/mermaid-init.js"></script>
<link href="mixed-effects-models_files/libs/quarto-diagram/mermaid.css" rel="stylesheet">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Mixed-Effects Models: A Practical Guide</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://github.com/colebrookson">Cole Brookson</a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Epidemiology of Microbial Disease
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 10, 2025</p>
    </div>
  </div>
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Abstract</div>
    <p>This research guide provides a comprehensive introduction to linear mixed-effects models. We begin with a discussion of the intuition behind mixed models, covering both theoretical foundations and practical implementation in R and Julia. Through a concrete example, we demonstrate how mixed models account for hierarchical data structures and within-group correlation.</p>
  </div>
</div>

<div>
  <div class="keywords">
    <div class="block-title">Keywords</div>
    <p></p><p>mixed-effects models, hierarchical models, multilevel models, random effects, variance components, longitudinal data, clustered data, R, Julia, <code>lme4</code>, <code>MixedModels.jl</code></p><p></p>
  </div>
</div>

</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>In standard linear regression we are interested in estimating the relationship between one or more independent variable(s), <span class="math inline">\(X\)</span> (also known as predictors, explanatory variables, or <em>fixed</em> effects), and some dependent variable <span class="math inline">\(Y\)</span>. However, often we encounter a fundamental problem early on in the analysis process when we recognize that, frustratingly, many datasets have hierarchical observation structures which are <em>not</em> independent (a requirement of simple linear regression). This non-independence can take many forms, but might be repeated measures on patients, measures on groups of students nested in schools, or experimental plots nested in different study fields. To deal with this challenge, researchers typically turn to an approach we call a <strong>mixed-effects model</strong>, which is an extension of a standard linear model as described above, typically containing only fixed effects. The key addition is the notion of a <strong>random effect</strong>, defined below, which allows for the accounting of within-group correlation, while also facilitating inference about both group-specific and population-level effects.</p>
<p>To define a mixed-effects model, we can introduce a new concept, known as a <strong>random effect</strong> (also known as a <strong>varying effect</strong>). However, we immediately find ourselves in definition jail with respect to what, specifically, a <strong>random effect</strong> means relative to a <strong>fixed effect</strong>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Definition
</div>
</div>
<div class="callout-body-container callout-body">
<p>Mixed-effects models in this context are models that include both (1) fixed effects, and (2) random effects. The definitions for such terms have been fought over in the literature for decades, but here we follow the definition of <span class="citation" data-cites="Gelman-AnalysisVarianceEver-2005a">Gelman (<a href="#ref-Gelman-AnalysisVarianceEver-2005a" role="doc-biblioref">2005</a>)</span>, such that <em>fixed effects</em> are used to mean the effects or coefficients that are identical for all groups in a population, and <em>random effects</em> are those which are allowed to differ from group to group.</p>
<p>We will explain further what we mean by this, but aim to put this warning front and centre should someone be looking for a ‚Äúmixed-effects‚Äù model containing the type of ‚Äúfixed effect‚Äù often referred to econometrics literature that has an entirely different interpretation.</p>
</div>
</div>
<p>In this guide we‚Äôll go over the formalism behind this kind of approach, when it‚Äôs useful, and how to implement a mixed-effects model in common programming languages.</p>
<div id="fig-modeltypes" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-modeltypes-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/midway-model-types.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-modeltypes-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Types of ‚Äúeffect‚Äù models. Image from <span class="citation" data-cites="Midway-Chapter9Effects-2022x">Midway (<a href="#ref-Midway-Chapter9Effects-2022x" role="doc-biblioref">2022</a>)</span>
</figcaption>
</figure>
</div>
<p>We‚Äôll also focus mainly on mixed-effects models with random intercepts, but will discuss the existence briefly of random slopes, and thus, random effects models. The formulation will be consistent with the classic frequentist approach &amp; language. We assume you‚Äôre familiar with the representation of fixed effects and simple linear regression in <a href="#fig-modeltypes" class="quarto-xref">Figure&nbsp;1</a>.</p>
</section>
<section id="methods" class="level1">
<h1>Methods</h1>
<section id="theoretical-intuition" class="level2">
<h2 class="anchored" data-anchor-id="theoretical-intuition">Theoretical Intuition</h2>
<p>Imagine we‚Äôre conducting a study investigating the effect of soil pH on crop yield. We have a number of experimental plots, which are nested within farms across different regions. Since each farm contributes multiple plots, we end up with a hierarchical data structure where observations within farms cannot be assumed independent. The set-up, visually, may look something like this:</p>
<div class="cell" data-fig-width="15" data-fig-height="10" data-layout-align="default">
<div class="cell-output-display">
<div id="fig-nested-farms" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-nested-farms-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-nested-farms">graph TD
    Farm1[Farm 1]:::farm1
    Farm2[Farm 2]:::farm2
    Farm3[Farm 3]:::farm3
    
    Farm1 --&gt; P1[Plot 1]:::plot
    Farm1 --&gt; P2[Plot 2]:::plot
    Farm1 --&gt; P3[Plot 3]:::plot
    Farm1 --&gt; P4[Plot 4]:::plot
    Farm1 --&gt; P5[Plot 5]:::plot
    
    Farm2 --&gt; P6[Plot 6]:::plot
    Farm2 --&gt; P7[Plot 7]:::plot
    Farm2 --&gt; P8[Plot 8]:::plot
    Farm2 --&gt; P9[Plot 9]:::plot
    Farm2 --&gt; P10[Plot 10]:::plot
    
    Farm3 --&gt; P11[Plot 11]:::plot
    Farm3 --&gt; P12[Plot 12]:::plot
    Farm3 --&gt; P13[Plot 13]:::plot
    Farm3 --&gt; P14[Plot 14]:::plot
    Farm3 --&gt; P15[Plot 15]:::plot
    
    classDef farm1 fill:#DEB887,stroke:#8B4513,stroke-width:5px,color:#000
    classDef farm2 fill:#F4A460,stroke:#A0522D,stroke-width:5px,color:#000
    classDef farm3 fill:#D2B48C,stroke:#8B7355,stroke-width:5px,color:#000
    classDef plot fill:#FFFFFF,stroke:#000000,stroke-width:4px,color:#000
</pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-nested-farms-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Nested plots within farms across different regions.
</figcaption>
</figure>
</div>
</div>
</div>
<p>This is exactly the use case for something like mixed-effects models. Such an approach allows us to account for within-group correlation while doing inference about both group-specific and population-level effects. To formalize this, say our simple linear model is</p>
<span class="math display">\[\begin{equation}

Y_{ij} = \beta_0 + \beta_1 x_{ij} + \epsilon_{ij}

\end{equation}\]</span>
<p>where we have measurements of crop yield, <span class="math inline">\(y_{ij}\)</span> in plots <span class="math inline">\(i\)</span>, nested within farm <span class="math inline">\(j\)</span>, as well as some soil pH levels, <span class="math inline">\(x_{ij}\)</span>. It follows that we may want to understand if there is some effect of the fixed effect soil pH on the crop yield. That is, we might want to do some form of standard linear regression to learn about our <span class="math inline">\(\beta\)</span> values. But, we‚Äôre faced with the possibility that each farm has characteristics specific to itself that may influence the crop yield. This could be a variety of different features, but often we can assume that some or all of them are unobserved.</p>
<p>Therefore, we can use a <strong>random effect</strong> to help control for this unobserved dependence.</p>
<section id="sec-raneffs" class="level3">
<h3 class="anchored" data-anchor-id="sec-raneffs">Random Effects</h3>
<p>In the most general sense, assume that there is some variable which takes <span class="math inline">\(k\)</span> possible values and is related to a response variable via a regression model. If there is some linear predictor that can be generated from this, we could construct the model (with no fixed effect) as <span class="math display">\[Y_{ij} = \beta_0 + \alpha_j + \epsilon_{ij}\]</span> with <span class="math inline">\(j = 1, ..., k-1\)</span>, where <span class="math inline">\(i\)</span> indexes the possible values of the explanatory variable, and <span class="math inline">\(\epsilon\)</span> is some error term. In our example, we consider <span class="math inline">\(j\)</span> to be indicators of which farm our samples are coming from. These <span class="math inline">\(\alpha_j\)</span>‚Äôs are referred to as random effects if they can be thought to arise from some random sample of a distribution, independent and identically distributed (i.i.d.) <span class="math display">\[\alpha_j \mathop\sim^{i.i.d.} N(0, \sigma^{2}_{\alpha}).\]</span> This looks very similar to a fixed effects model, but importantly, in the frequentist space, we consider fixed effects to be <em>fixed, unknown parameters</em>, whereas these are (of course), random. This means that with our simple model, we have the expected value of <span class="math inline">\(Y_{ij}\)</span> being <span class="math display">\[E[Y_{ij}] = \beta_0,\]</span> and the variance is <span class="math display">\[Var(Y_{ij}) = \sigma_{\alpha}^2 + \sigma^2.\]</span> Importantly, we‚Äôre then left with a correlation structure <span class="math display">\[\begin{align}
\text{Cor}(Y_{ij},Y_{kl}) =
\begin{cases}
0&amp; i\neq k \\
\sigma^2_{\alpha}/(\sigma^2_{\alpha} + \sigma^2)&amp; i=k,j \neq l \\
1&amp; i = k, j = l
\end{cases}
\end{align}\]</span></p>
<p>What this correlation structure tells us is essential for interpreting random effects. Essentially, observations from <em>different</em> farms (the <span class="math inline">\(i \neq k\)</span> case) are uncorrelated, while observations from the <em>same</em> farm (<span class="math inline">\(i=k\)</span> case) are indeed correlated. This form of correlation has a few different terms, but we follow the common term of <strong>intraclass correlation (ICC)</strong>, and is given as in the above equation, as <span class="math inline">\(\sigma^2_{\alpha}/(\sigma^2_{\alpha} + \sigma^2)\)</span>. If the ICC is large, observations from the <em>same farm</em> are much more similar than observations from <em>different farms</em>.</p>
</section>
<section id="random-intercepts-model" class="level3">
<h3 class="anchored" data-anchor-id="random-intercepts-model">Random Intercepts Model</h3>
<p>Now that we have a foundation of a <em>random effect</em>, let us consider them in the context where there is also a fixed effect that we wish to estimate. The model, as we wrote it before, will now include our single fixed effect of interest, and our random effect of farm.</p>
<p><span class="math display">\[Y_{ij} = \beta_0 + \beta_1 X_{ij} + \alpha_j + \epsilon_{ij}\]</span></p>
<p>This is to be interpreted, in plain english, as a simple linear mixed-effects model with a fixed effect of soil pH, and a random effect on farm. In this formulation, we are assuming that our random effect takes the form of a <strong>random intercept</strong>. Which is to say, we assume the relationship between soil pH and yield to operates with the same form in each place, but that there are likely differences in soil pH generally between farm locations. So the per-unit change of <span class="math inline">\(X_{ij}\)</span> leads to the same per-unit change in <span class="math inline">\(Y_{ij}\)</span>, and therefore we can estimate one population-level <span class="math inline">\(\beta\)</span> value. Let‚Äôs visualize this:</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-soil-data" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-soil-data-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="mixed-effects-models_files/figure-html/fig-soil-data-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-soil-data-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Simulated data for this example, coloured by farm.
</figcaption>
</figure>
</div>
</div>
</div>
<p>In <a href="#fig-soil-data" class="quarto-xref">Figure&nbsp;3</a> we can clearly see that there is a discernable relationship between points of the same colour, but, at least looking at it, we can see that the the relationship between the two variables are probably linear. We can preview what will come out of our analysis by putting some lines through each set of points.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we'll show how to read in this data example later on!</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> field_data) <span class="sc">+</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> soil_pH, <span class="at">y =</span> yield, <span class="at">colour =</span> farm_id)) <span class="sc">+</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">x =</span> soil_pH, <span class="at">y =</span> yield,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">group =</span> farm_id, <span class="at">colour =</span> farm_id</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> lm</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Soil pH"</span>, <span class="at">y =</span> <span class="st">"Crop Yield"</span>) <span class="sc">+</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="st">"Farm ID"</span>, <span class="at">values =</span> MoMAColors<span class="sc">::</span><span class="fu">moma.colors</span>(<span class="st">"OKeeffe"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-soil-data-lm" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-soil-data-lm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="mixed-effects-models_files/figure-html/fig-soil-data-lm-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-soil-data-lm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Simulated data for this example, coloured by farm, with a simple line of best fit, grouped by farm.
</figcaption>
</figure>
</div>
</div>
</div>
<p>There are some obvious differences here in <a href="#fig-soil-data-lm" class="quarto-xref">Figure&nbsp;4</a>, and it <em>appears</em> as though perhaps the intercepts for the different farms might be different. Having done this brief visualization, let‚Äôs look at how we can actually estimate our model.</p>
</section>
</section>
<section id="formalism" class="level2">
<h2 class="anchored" data-anchor-id="formalism">Formalism</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you don‚Äôt especially care about how all of this works under the hood, but have read up to this point, you can probably safely skip to <a href="@sec-implementation">Implementation</a> section below <span class="emoji" data-emoji="grin">üòÅ</span>.</p>
</div>
</div>
<p>So that we do not lose generality, let us consider the model where there are two random variables: <span class="math inline">\(\mathcal{Y}\)</span>, the <span class="math inline">\(n\)</span>-dimensional vector of responses, and <span class="math inline">\(\mathcal{B}\)</span>, the <span class="math inline">\(q\)</span>-dimensional vector of random <em>effects</em>. We of course observe some value of <span class="math inline">\(\mathcal{Y}\)</span>, which we note as <span class="math inline">\(\mathbf{y}\)</span>, but based on how we <a href="@sec-raneffs">defined a random effect as a random variable</a>, we definitionally do <strong>not</strong> observe the value <span class="math inline">\(\mathbf{b}\)</span> of <span class="math inline">\(\mathcal{B}\)</span>.</p>
<p>The unconditional distribution of <span class="math inline">\(\mathcal{B}\)</span> (that is, the distribution before we observe any data) is given by <span class="math inline">\(\mathcal{B}\sim\mathcal{N}(\mathbf{0},\Sigma_\theta)\)</span>, where <span class="math inline">\(\Sigma_\theta\)</span> is a variance-covariance matrix that depends on our variance-component parameter, <span class="math inline">\(\theta\)</span>. The variance-component parameter <span class="math inline">\(\theta\)</span> controls how much variation we expect to see in our random effects. In the simplest case of a random intercept model, <span class="math inline">\(\theta\)</span> might be a single number that determines the standard deviation of the random intercepts. In our soil pH example, this would control how much we expect the baseline crop yield to vary from field to field. In more complex models, <span class="math inline">\(\theta\)</span> can be a vector of multiple parameters that control not just the variance of different random effects, but also how they covary with each other. For instance, if we had both random intercepts and random slopes for pH effect by field, <span class="math inline">\(\theta\)</span> would include parameters controlling the variance of intercepts, the variance of slopes, and the correlation between them.</p>
<p>In this case, we end up with a linear predictor <span class="math inline">\(\mathbf{X}\beta + \mathbf{Z}\mathbf{b}\)</span>, which is the conditional mean of <span class="math inline">\(\mathcal{Y}\)</span>, given <span class="math inline">\(\mathcal{B} = \mathbf{b}\)</span>. Since we are dealing with the linear mixed-effects model case for now, the conditional distribution <span class="math inline">\((\mathcal{Y}|\mathcal{B}=\mathbf{b})\)</span> is given by <span class="math display">\[ (\mathcal{Y}|\mathcal{B}=\mathbf{b}) \sim \mathcal{N}(\mathbf{X}\beta + \mathbf{Z}\mathbf{b}, \sigma^2 \mathbf{I}),\]</span> where <span class="math inline">\(\mathbf{I}\)</span> is the identity matrix.</p>
<p>To make the computational machinery work more efficiently, we introduce what are called <strong>spherical random effects</strong>, denoted <span class="math inline">\(\mathcal{U}\)</span>. The term ‚Äúspherical‚Äù here refers to random effects that have been standardized so that they have no correlation with each other and all have the same variance. Think of this as similar to converting raw test scores to z-scores. These spherical random effects are related to our actual random effects through the transformation <span class="math display">\[\mathcal{B}=\Lambda_\theta\mathcal{U},\]</span> where <span class="math inline">\(\Lambda_\theta\)</span> is called the relative covariance factor. This transformation essentially allows us to work with a simpler, standardized version of the problem during computation, then transform back to get results on the original scale. In our soil pH example, if we had random effects for different fields that were correlated (perhaps because nearby fields share soil characteristics), the spherical random effects would represent a transformed version where those correlations have been removed.</p>
<p>This is where the rubber meets the road computationally. We arrive at the challenge of computing the maximum likelihood estimation of the variance-component parameter <span class="math inline">\(\theta\)</span>, which we term <span class="math inline">\(\hat{\theta}\)</span>, that minimizes what is called the profiled log-likelihood. The actual value of <span class="math inline">\(\hat{\theta}\)</span> is obtained through numerical optimization, the details of which will depend on the software package at hand. In the process of evaluating our profiled log-likelihood and finding this optimal <span class="math inline">\(\hat{\theta}\)</span>, we simultaneously obtain several other quantities: <span class="math inline">\(\hat{\beta}\)</span>, which is our estimate for the coefficients of the fixed effects, and <span class="math inline">\(\tilde{\mathbf{u}}_{\hat{\theta}}\)</span>, which is the conditional mode of the spherical random effects <span class="math inline">\(\mathcal{U}\)</span> (that is, the value of <span class="math inline">\(\mathbf{u}\)</span> that is most likely given the data we observed).</p>
<p>We then transform these conditional modes of the spherical random effects back to the original scale of our random effects using <span class="math display">\[\tilde{\mathbf{b}}_{\hat{\theta}} = \Lambda_{\hat{\theta}}\tilde{\mathbf{u}}_{\hat{\theta}}.\]</span> These values <span class="math inline">\(\tilde{\mathbf{b}}_{\hat{\theta}}\)</span> represent the values of <span class="math inline">\(\mathbf{b}\)</span> that maximize the density of the conditional distribution <span class="math inline">\(\mathcal{B}|\mathcal{Y} = \mathbf{y}\)</span>. In plain language, these are our best guesses for the random effect values given the data we actually observed. You will often see these called the <strong>best linear unbiased predictors</strong> (BLUPs) or conditional modes. In our soil pH example, these would be the estimated effect of each specific field on crop yield. For a linear mixed model where all distributions are Gaussian (normal), these conditional modes are also equal to the conditional means, which is a convenient mathematical property.</p>
</section>
<section id="estimation-via-restricted-maximum-likelihood" class="level2">
<h2 class="anchored" data-anchor-id="estimation-via-restricted-maximum-likelihood">Estimation via (Restricted) Maximum Likelihood</h2>
<p>When we use mixed-effects models, we often fit the models via a maximum liklihood estimation proceedure, with the most common form of it being restricted maximum liklihood (REML). More details about this method along with some notes ot pay attention to are in the <a href="@sec-reml">appendix on REML</a></p>
<p>Why restricted? Maximum likelihood estimation of variance components in mixed-effects models suffers from a well-known deficiency: the estimates are biased downward because the procedure fails to account for the degrees of freedom consumed in estimating the fixed effects, much as the sample variance requires division by <span class="math inline">\(n-1\)</span> rather than <span class="math inline">\(n\)</span> to correct for the estimation of the mean. Restricted maximum likelihood remedies this problem by basing inference on <span class="math inline">\(n-p\)</span> error contrasts‚Äîlinear combinations of the data that contain no information about the fixed effects‚Äîthereby properly accounting for the uncertainty introduced by estimating <span class="math inline">\(\beta\)</span>. While REML produces less biased estimates of variance components and is thus preferred for final model fitting, it cannot be used to compare models with different fixed effects structures, as the restricted likelihoods under different fixed effects specifications involve different transformations of the data and are therefore not comparable. Consequently, the recommended practice is to use ordinary maximum likelihood when selecting among competing fixed effects structures via likelihood ratio tests or information criteria, and then to refit the chosen model using REML to obtain optimal estimates of the variance components.</p>
</section>
<section id="assumptions" class="level2">
<h2 class="anchored" data-anchor-id="assumptions">Assumptions</h2>
<p>Many of the assumptions of a linear mixed effect model are the same as a standard linear model, which are covered in the <a href="LINK">OLS regression research guide</a>. Briefly, the most important assumptions are:</p>
<ol type="1">
<li><strong>Linearity:</strong> The relationships between the predictors and the response variable are linear</li>
<li><strong>Independence of residuals:</strong> Conditional on the fixed and random effects, the residuals are independent of each other.</li>
<li><strong>Normality of residuals:</strong> The residuals are normally distributed.</li>
<li><strong>Constant variance of residuals (Homoscedasticity):</strong> The spread of the residuals is consistent across all levels of the predictors.</li>
<li><strong>No multicollinearity:</strong> The independent variables are not strongly correlated with one another.</li>
<li><strong>Normal distribution of random effects:</strong> The random effects are assumed to be normally distributed</li>
</ol>
<p>Checking these (mostly) occurs after the model is fit or at the experimental design stage, so we‚Äôll focus exclusively on the assumptions that can be checked once a model has been fit or during the fitting process.</p>
</section>
</section>
<section id="sec-implementation" class="level1">
<h1>Implementation</h1>
<p>In this section we go over how to actually <em>fit</em> these models in programatic softwares.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
With Great (Computational) Power Comes Great Responsibility
</div>
</div>
<div class="callout-body-container callout-body">
<p>Modern statistical softwares, as you are about to see, have come a <em>long</em> way in terms of making computing these actually very complex models, <em>very</em> easy. One can fit a linear mixed-effects model in R in as few as 10 lines of code. <strong>We wish to stress that this simplicity of implementation is not to be confused with simplicity of the method.</strong></p>
<p>There are a lot of important details going on under the hood, and it is any responsible researcher‚Äôs duty to ensure that they themselves are sufficiently aware of the eccentricites of their own data, model, and software to reliably interpret results. Just because the code ran doesn‚Äôt mean your answer is correct, and it is almost always worth reading the excellent documentation for whatever methods you‚Äôre using (in this case, the <a href="https://cran.r-project.org/web/packages/lme4/lme4.pdf"><code>lme4</code></a> package for R and the <a href="https://juliastats.org/MixedModels.jl/dev/"><code>MixedModels.jl</code></a> package for Julia.)</p>
</div>
</div>
<section id="random-intercepts-model-1" class="level2">
<h2 class="anchored" data-anchor-id="random-intercepts-model-1">Random Intercepts Model</h2>
<p>Recall our soil pH and crop yield example where we showed a quick plot in <a href="#fig-soil-data-lm" class="quarto-xref">Figure&nbsp;4</a> indicating that there were almost certainly differences between our farms in terms of their intercepts. So, we can simply fit a linear mixed-effects model, with the goal of estimating a (fixed) effect of soil pH on crop yield (i.e., what is the ‚Äúslope‚Äù of the relationship), and a random effect on the intercept (i.e., what are the intercepts of each farm). Quickly, let‚Äôs set up our model.</p>
<p>In our soil pH example, our statistical model is <span class="math display">\[Y_{ij} = \beta_0 + \beta_1 X_{ij} + \alpha_{j} + \epsilon_{ij}\]</span> where <span class="math inline">\(Y_{ij}\)</span> is the measurement of crop yeild at plot <span class="math inline">\(i\)</span> in farm <span class="math inline">\(j\)</span>, <span class="math inline">\(\beta_0\)</span> is our population-level intercept, <span class="math inline">\(\beta_1\)</span> is the to-be-estimated effect or coefficient of <span class="math inline">\(X_{ij}\)</span>, the measurement of soil pH at plot <span class="math inline">\(i\)</span> in farm <span class="math inline">\(j\)</span>, <span class="math inline">\(\alpha_j\)</span> is the random effect on the intercept for each group (farm), <span class="math inline">\(j\)</span>, and then <span class="math inline">\(\epsilon\)</span> is our error term.</p>
<p>We need to translate this into code. In these languages, we use what‚Äôs called a <em>formula</em> to describe our statistical model. The general form of that formula is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>response <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> fixed_effect <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>random_intercept)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where we can add arbitrarily many fixed effects, e.g.,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>response <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> fixed_effect_1 <span class="sc">+</span> fixed_effect_2 <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>random_intercept_1) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>random_intercept_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here, in our formula, you‚Äôll notice we have this <code>... ~ 1 + ...</code> hanging out in the middle. This explicitly indicatess the presence of an intercept term in the model (i.e.&nbsp;the code-equivalent of <span class="math inline">\(\beta_0\)</span> in our model equation). In most statistical software packages, it‚Äôs assumed that an intercept will be present, since models without them are rare.</p>
<p>The interpretation of the intercept in this case is the intercept would represent the expected crop yield when pH equals zero (which would be nonsensical in practice, but that is its mathematical interpretation). The model would estimate this baseline value along with the effect of changing pH. In most formula interfaces, including R and Julia‚Äôs, <strong>an intercept is included by default even if you don‚Äôt write one</strong>. This means that <code>response ~ fixed_effect</code> and <code>response ~ 1 + fixed_effect</code> are equivalent and both include an intercept. Here, we believe it‚Äôs optional, but will always include it for clarity, and encourage others to do the same.</p>
</div>
</div>
<p>Now, to some code! Let‚Äôs first get a sense of what our data actually look like for this example.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">Julia</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># some set up! </span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># load in the data from our local location </span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>field_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">here</span>(<span class="st">"./research-guides/mixed-effects-models/data/crop_yield_data.csv"</span>),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">show_col_types =</span> <span class="cn">FALSE</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(field_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 √ó 4
  farm_id plot_id soil_pH yield
    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;
1       1       1    7.06 143. 
2       1       2    6.58 106. 
3       1       3    6.32 122. 
4       1       4    6.39 138. 
5       1       5    6.41 112. 
6       1       6    6.19  92.7</code></pre>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># some set up! </span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">DataFrames</span>, <span class="bu">CSV</span>, <span class="bu">Base.Filesystem</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">#  project_root = @__DIR__ # if we need to double check where the directory is pointing rn </span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># load the data from local location</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>field_data <span class="op">=</span> CSV.<span class="fu">read</span>(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">joinpath</span>(<span class="pp">@__DIR__</span>, <span class="st">"./data/crop_yield_data.csv"</span>),</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    DataFrame</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>150√ó4 DataFrame
 Row ‚îÇ farm_id  plot_id  soil_pH  yield
     ‚îÇ Int64    Int64    Float64  Float64
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   1 ‚îÇ       1        1  7.06464  143.0
   2 ‚îÇ       1        2  6.57797  106.061
   3 ‚îÇ       1        3  6.32341  122.438
   4 ‚îÇ       1        4  6.38518  137.577
   5 ‚îÇ       1        5  6.41172  112.132
   6 ‚îÇ       1        6  6.19462   92.6556
   7 ‚îÇ       1        7  7.32745  135.555
   8 ‚îÇ       1        8  5.90546  118.104
  ‚ãÆ  ‚îÇ    ‚ãÆ        ‚ãÆ        ‚ãÆ        ‚ãÆ
 144 ‚îÇ       5      144  5.40329   65.022
 145 ‚îÇ       5      145  5.96985   81.1347
 146 ‚îÇ       5      146  6.85269   77.3114
 147 ‚îÇ       5      147  6.1639    65.7406
 148 ‚îÇ       5      148  6.52858   64.3481
 149 ‚îÇ       5      149  6.86806   69.387
 150 ‚îÇ       5      150  6.73596   87.4023
                           135 rows omitted</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>We‚Äôre dealing with clean data in this case, so we‚Äôre skipping some common data cleaning steps that may normally come here.</p>
<section id="fitting-the-model" class="level3">
<h3 class="anchored" data-anchor-id="fitting-the-model">Fitting the model</h3>
<p>Without further ado, let‚Äôs actually fit our models.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true" href="">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false" href="">Julia</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4, <span class="at">quietly=</span><span class="cn">TRUE</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># random intercepts model</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>model_ri <span class="ot">&lt;-</span> <span class="fu">lmer</span>(</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    yield <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> soil_pH <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>farm_id),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> field_data,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">REML =</span> <span class="cn">TRUE</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co"># this shows the model summary</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_ri)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: yield ~ 1 + soil_pH + (1 | farm_id)
   Data: field_data

REML criterion at convergence: 1184.4

Scaled residuals: 
     Min       1Q   Median       3Q      Max 
-2.77492 -0.67190  0.03397  0.78095  2.55810 

Random effects:
 Groups   Name        Variance Std.Dev.
 farm_id  (Intercept) 405.1    20.13   
 Residual             146.5    12.10   
Number of obs: 150, groups:  farm_id, 5

Fixed effects:
            Estimate Std. Error t value
(Intercept)   -7.407     15.921  -0.465
soil_pH       16.034      2.002   8.007

Correlation of Fixed Effects:
        (Intr)
soil_pH -0.823</code></pre>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">MixedModels</span>, <span class="bu">StatsBase</span>, <span class="bu">StatsModels</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># random intercepts model (structure essentially identical)</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>model_ri <span class="op">=</span> <span class="fu">fit</span>(</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    MixedModel,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@formula</span>(yield <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> soil_pH <span class="op">+</span> (<span class="fl">1</span> <span class="op">|</span> farm_id)),</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    field_data,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    REML<span class="op">=</span><span class="cn">true</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>) <span class="co"># model summary displayed automatically</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML
 yield ~ 1 + soil_pH + (1 | farm_id)
 REML criterion at convergence: 1184.4262456837705

Variance components:
            Column   Variance Std.Dev.
farm_id  (Intercept)  405.0656 20.1262
Residual              146.5110 12.1042
 Number of obs: 150; levels of grouping factors: 5

  Fixed-effects parameters:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                Coef.  Std. Error      z  Pr(&gt;|z|)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(Intercept)  -7.40672    15.9206   -0.47    0.6418
soil_pH      16.0336      2.00237   8.01    &lt;1e-14
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Ok so the model summaries both provide some key pieces of interformation. Perhaps most importantly, and what most people want to see right away is the population-level intercept and the effect of soil pH on crop yield (under the ‚ÄúFixed Effects‚Äù header for R and the ‚ÄúFixed-effects parameters‚Äù header for Julia). As a reminder, these two terms essentially refer to (a) the (nonsensical but instructive) estimated values of yeild should soil pH be 0, and (b) coefficient or slope that tells us what the per-unit change in yield is from a per-unit change in soil pH. The random effects section quantifies the variation attributable to differences between farms (the between-farm variance) and the residual variation within farms (the within-farm variance). These variance components allow us to partition the total variation in crop yield into systematic farm-level differences and plot-level residual variation.</p>
<p>The ratio of these variance components is informative. A large farm-level variance relative to the residual variance indicates substantial heterogeneity between farms, justifying our decision to use a mixed-effects model rather than ordinary least squares regression. We can calculate the intraclass correlation coefficient to quantify the proportion of total variance attributable to farm-level differences.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true" href="">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false" href="">Julia</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get out the variance components</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>var_components <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">VarCorr</span>(model_ri))</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>farm_var <span class="ot">&lt;-</span> var_components<span class="sc">$</span>vcov[<span class="dv">1</span>]</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>residual_var <span class="ot">&lt;-</span> var_components<span class="sc">$</span>vcov[<span class="dv">2</span>]</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate icc manually</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>icc <span class="ot">&lt;-</span> farm_var <span class="sc">/</span> (farm_var <span class="sc">+</span> residual_var)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Intraclass Correlation Coefficient:"</span>, <span class="fu">round</span>(icc, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Intraclass Correlation Coefficient: 0.734 </code></pre>
</div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get out the variance components</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>vc <span class="op">=</span> <span class="fu">VarCorr</span>(model_ri);</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>farm_var <span class="op">=</span> vc.œÉœÅ.farm_id.œÉ[<span class="fl">1</span>]<span class="op">^</span><span class="fl">2</span>;</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>residual_var <span class="op">=</span> vc.s<span class="op">^</span><span class="fl">2</span>;</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate icc manually</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>icc <span class="op">=</span> farm_var <span class="op">/</span> (farm_var <span class="op">+</span> residual_var);</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"Intraclass Correlation Coefficient: "</span>, <span class="fu">round</span>(icc, digits<span class="op">=</span><span class="fl">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Intraclass Correlation Coefficient: 0.734</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>That‚Äôs a pretty high value!</p>
</section>
<section id="assumption-checking" class="level3">
<h3 class="anchored" data-anchor-id="assumption-checking">Assumption Checking</h3>
<p>Great, the models are fit, and we can interpret our results. Before we do so however, we need to verify the assumptions underlying our inferences. As discussed earlier, several assumptions must hold for our model to provide valid estimates and appropriate uncertainty quantification.</p>
<section id="residual-diagnostics" class="level4">
<h4 class="anchored" data-anchor-id="residual-diagnostics">Residual Diagnostics</h4>
<p>We begin by examining the residuals for evidence of normality and homoscedasticity. The residuals should be approximately normally distributed and should exhibit constant variance across the range of fitted values.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true" href="">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false" href="">Julia</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># residuals and fitted values</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>field_data<span class="sc">$</span>residuals <span class="ot">&lt;-</span> <span class="fu">residuals</span>(model_ri)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>field_data<span class="sc">$</span>fitted <span class="ot">&lt;-</span> <span class="fu">fitted</span>(model_ri)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># diagnostic plots</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Q-Q plot for normality of residuals</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(field_data<span class="sc">$</span>residuals, <span class="at">main =</span> <span class="st">"Q-Q Plot of Residuals"</span>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(field_data<span class="sc">$</span>residuals, <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co"># homoscedasticity check</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(field_data<span class="sc">$</span>fitted, field_data<span class="sc">$</span>residuals,</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Fitted Values"</span>, <span class="at">ylab =</span> <span class="st">"Residuals"</span>,</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Residuals vs Fitted Values"</span>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="co"># residuals</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(field_data<span class="sc">$</span>residuals, <span class="at">breaks =</span> <span class="dv">20</span>, </span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Distribution of Residuals"</span>,</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Residuals"</span>)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="co"># residuals vs predictor</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(field_data<span class="sc">$</span>soil_pH, field_data<span class="sc">$</span>residuals,</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Soil pH"</span>, <span class="at">ylab =</span> <span class="st">"Residuals"</span>,</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Residuals vs Soil pH"</span>)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mixed-effects-models_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Plots</span>, <span class="bu">Distributions</span>, <span class="bu">StatsPlots</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># extract residuals and fitted values</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>field_data.residuals <span class="op">=</span> <span class="fu">residuals</span>(model_ri);</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>field_data.fitted <span class="op">=</span> <span class="fu">fitted</span>(model_ri);</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Q-Q plot of residuals</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>p1 <span class="op">=</span> <span class="fu">plot</span>(<span class="fu">qqplot</span>(Normal, field_data.residuals),</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    xlabel<span class="op">=</span><span class="st">"Theoretical Quantiles"</span>,</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">"Sample Quantiles"</span>,</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Q-Q Plot of Residuals"</span>,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="cn">false</span>);</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="co"># homoscedasticity </span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>p2 <span class="op">=</span> <span class="fu">scatter</span>(field_data.fitted, field_data.residuals,</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    xlabel<span class="op">=</span><span class="st">"Fitted Values"</span>,</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">"Residuals"</span>,</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Residuals vs Fitted Values"</span>,</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="cn">false</span>,</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.6</span>);</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="fu">hline!</span>([<span class="fl">0</span>], color<span class="op">=:</span>red, linestyle<span class="op">=:</span>dash);</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="co"># hist of residuals</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>p3 <span class="op">=</span> <span class="fu">histogram</span>(field_data.residuals,</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    xlabel<span class="op">=</span><span class="st">"Residuals"</span>,</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">"Frequency"</span>,</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Distribution of Residuals"</span>,</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="cn">false</span>,</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    bins<span class="op">=</span><span class="fl">20</span>);</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="co"># residuals vs predictor</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>p4 <span class="op">=</span> <span class="fu">scatter</span>(field_data.soil_pH, field_data.residuals,</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    xlabel<span class="op">=</span><span class="st">"Soil pH"</span>,</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">"Residuals"</span>,</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Residuals vs Soil pH"</span>,</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="cn">false</span>,</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.6</span>);</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a><span class="fu">hline!</span>([<span class="fl">0</span>], color<span class="op">=:</span>red, linestyle<span class="op">=:</span>dash);</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a><span class="fu">plot!</span>(p1, p2, p3, p4, layout<span class="op">=</span>(<span class="fl">2</span>, <span class="fl">2</span>), size<span class="op">=</span>(<span class="fl">1100</span>, <span class="fl">900</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mixed-effects-models_files/figure-html/unnamed-chunk-14-J1.png" class="img-fluid figure-img" width="550"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>The Q-Q plot allows us to assess whether the residuals follow a normal distribution. Points should fall approximately along the diagonal line, with systematic departures indicating non-normality. The residuals versus fitted values plot assesses homoscedasticity. We look for a random scatter of points around zero with no systematic patterns such as funneling or curvature. The residuals versus predictor plot serves a similar purpose, checking whether the variance changes systematically with soil pH. All of these look quite good. And reassuringly, we can check our outputs from both languages (R and Julia) and see the results thus far are the same!</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Interpreting Residual Plots
</div>
</div>
<div class="callout-body-container callout-body">
<p>When examining residual plots, we are looking for the absence of patterns rather than the presence of specific features. A good residual plot shows points scattered randomly around zero with no trends, curves, or changes in spread. The reason for this is that patterns in these plots indicate violations of model assumptions that may require remedial action such as transformations or different model specifications. If you can‚Äôt see anything interesting, the plots pass the check.</p>
</div>
</div>
</section>
<section id="random-effects-diagnostics" class="level4">
<h4 class="anchored" data-anchor-id="random-effects-diagnostics">Random Effects Diagnostics</h4>
<p>We must also verify that the random intercepts are approximately normally distributed. Let‚Äôs extract the best linear unbiased predictors (BLUPs) or conditional modes for each farm and examine their distribution.</p>
<div class="callout-imp">
<p>One thing to note is that the number of levels we have for our random effect is small, since this is an example dataset. It‚Äôs generally a rule of thumb that one should have <strong>minimum</strong> five levels (which is what we do) to justify a random effect. Below five levels <em>can</em> be possible if one isn‚Äôt interested in making inference about the random effect itself, but five is the bare minimum, typically.</p>
</div>
<p>Since we have a very small number of levels in our random effect, we can‚Äôt do something like a <a href="https://en.wikipedia.org/wiki/Shapiro%E2%80%93Wilk_test">Shapiro-Wilk test</a> to check for normality, and we have to rely on the Q-Q plot, even though that as well is a challenge to assess with such few levels. In this case, we‚Äôre looking for large, obvious deviations from our straight line.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-5-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-1" role="tab" aria-controls="tabset-5-1" aria-selected="true" href="">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-2" role="tab" aria-controls="tabset-5-2" aria-selected="false" href="">Julia</a></li></ul>
<div class="tab-content">
<div id="tabset-5-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-5-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get random effects</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>random_effects <span class="ot">&lt;-</span> <span class="fu">ranef</span>(model_ri)<span class="sc">$</span>farm_id</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(random_effects) <span class="ot">&lt;-</span> <span class="st">"intercept"</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Q-Q plot on random effects</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(random_effects<span class="sc">$</span>intercept, </span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">main =</span> <span class="st">"Q-Q Plot of Random Intercepts"</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(random_effects<span class="sc">$</span>intercept, <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co"># hist of random effects</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(random_effects<span class="sc">$</span>intercept, <span class="at">breaks =</span> <span class="dv">10</span>,</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Distribution of Random Intercepts"</span>,</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Random Intercept"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mixed-effects-models_files/figure-html/unnamed-chunk-15-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-5-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># extract via ranef but then turn from Vector{Matrix{Float64}} to just a flat</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># vector for easy plotting</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>random_effects <span class="op">=</span> <span class="fu">vec</span>(<span class="fu">reduce</span>(vcat, <span class="fu">ranef</span>(model_ri)));</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Q-Q plot for random effects</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>p1 <span class="op">=</span> <span class="fu">plot</span>(<span class="fu">qqplot</span>(Normal, random_effects),</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    xlabel<span class="op">=</span><span class="st">"Theoretical Quantiles"</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">"Sample Quantiles"</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Q-Q Plot of Random Intercepts"</span>,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="cn">false</span>);</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co"># hist of random effects</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>p2 <span class="op">=</span> <span class="fu">histogram</span>(random_effects,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    xlabel<span class="op">=</span><span class="st">"Random Intercept"</span>,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">"Frequency"</span>,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Distribution of Random Intercepts"</span>,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="cn">false</span>,</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    bins<span class="op">=</span><span class="fl">10</span>);</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p1, p2, layout<span class="op">=</span>(<span class="fl">1</span>, <span class="fl">2</span>), size<span class="op">=</span>(<span class="fl">800</span>, <span class="fl">350</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mixed-effects-models_files/figure-html/unnamed-chunk-16-J1.png" class="img-fluid figure-img" width="400"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>The distribution of random intercepts reveals whether our assumption of normally distributed farm effects is reasonable. Substantial departures from normality may indicate the presence of outlying farms or suggest that the random effects structure requires modification.</p>
</section>
</section>
<section id="visualizing-the-fitted-model" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-the-fitted-model">Visualizing the Fitted Model</h3>
<p>Having verified that our model assumptions are reasonably satisfied, we can proceed to visualize the fitted relationships. These visualizations serve both to communicate our findings and to provide a final informal check of model adequacy. Importantly, this will involve us calculating our model <strong>predictions</strong>. Our model predictions will allow us to look at how our model creates a smooth relationship between our variables of interest.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-6-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-1" role="tab" aria-controls="tabset-6-1" aria-selected="true" href="">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-6-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-2" role="tab" aria-controls="tabset-6-2" aria-selected="false" href="">Julia</a></li></ul>
<div class="tab-content">
<div id="tabset-6-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-6-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get a sequence of pH values for prediction</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>ph_range <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(field_data<span class="sc">$</span>soil_pH), </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>                <span class="fu">max</span>(field_data<span class="sc">$</span>soil_pH), </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Population-level (fixed effects) prediction</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>pop_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_ri, </span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">soil_pH =</span> ph_range),</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>                    <span class="at">re.form =</span> <span class="cn">NA</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(field_data, <span class="fu">aes</span>(<span class="at">x =</span> soil_pH, <span class="at">y =</span> yield)) <span class="sc">+</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># put the individual farms</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">factor</span>(farm_id)), <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># now farm-specific lines</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> fitted, <span class="at">group =</span> farm_id, <span class="at">color =</span> <span class="fu">factor</span>(farm_id)),</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>              <span class="at">linewidth =</span> <span class="fl">0.8</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># now the trend overall</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">soil_pH =</span> ph_range, <span class="at">yield =</span> pop_pred),</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> soil_pH, <span class="at">y =</span> yield),</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>              <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Soil pH"</span>,</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Crop Yield (kg/ha)"</span>,</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>         <span class="at">title =</span> <span class="st">"Random Intercepts Model: Crop Yield vs Soil pH"</span>,</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="st">"Dashed line: population average; Colored lines: farm-specific predictions"</span>,</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>         <span class="at">color =</span> <span class="st">"Farm"</span>) <span class="sc">+</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mixed-effects-models_files/figure-html/unnamed-chunk-17-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-6-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-6-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get a sequence of pH values for prediction</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>ph_range <span class="op">=</span> <span class="fu">collect</span>(<span class="fu">range</span>(<span class="fu">minimum</span>(field_data.soil_pH),</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">maximum</span>(field_data.soil_pH),</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    length<span class="op">=</span><span class="fl">100</span>));</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Population-level (fixed effects) prediction</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>pop_pred_data <span class="op">=</span> <span class="fu">DataFrame</span>(</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    soil_pH<span class="op">=</span>ph_range,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    farm_id<span class="op">=</span><span class="fu">repeat</span>([<span class="st">"Farm_01"</span>], <span class="bu">Base</span>.<span class="fu">length</span>(ph_range)),</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    yield<span class="op">=</span><span class="fu">zeros</span>(<span class="bu">Base</span>.<span class="fu">length</span>(ph_range))</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>pop_pred <span class="op">=</span> <span class="fu">predict</span>(model_ri, pop_pred_data, new_re_levels<span class="op">=:</span>population);</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> <span class="fu">scatter</span>(field_data.soil_pH, field_data.yield,</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    group<span class="op">=</span>field_data.farm_id,</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    xlabel<span class="op">=</span><span class="st">"Soil pH"</span>,</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">"Crop Yield (kg/ha)"</span>,</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Random Intercepts Model: Crop Yield vs Soil pH"</span>,</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.6</span>,</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    markersize<span class="op">=</span><span class="fl">4</span>,</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=:</span>outerright,</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="fu">permutedims</span>(<span class="fu">unique</span>(field_data.farm_id)));</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="co"># add farm-specific fitted lines</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> farm <span class="kw">in</span> <span class="fu">unique</span>(field_data.farm_id)</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    farm_data <span class="op">=</span> field_data[field_data.farm_id<span class="op">.==</span>farm, <span class="op">:</span>]</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot!</span>(farm_data.soil_pH, farm_data.fitted,</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>        linewidth<span class="op">=</span><span class="fl">2</span>,</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a><span class="co"># add population-level trend finally</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a><span class="fu">plot!</span>(ph_range, pop_pred,</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=:</span>black,</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>    linewidth<span class="op">=</span><span class="fl">2</span>,</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>    linestyle<span class="op">=:</span>dash,</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Population Average"</span>,</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>    size<span class="op">=</span>(<span class="fl">1100</span>, <span class="fl">900</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mixed-effects-models_files/figure-html/unnamed-chunk-18-J1.png" class="img-fluid figure-img" width="550"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>This nice plot we‚Äôve made here illustrates the essential structure of the random intercepts model. Each farm has its own fitted line, all sharing the same slope (the effect of soil pH) but with different intercepts reflecting farm-specific baseline productivity. The population-average line represents the expected relationship for a typical farm, averaged across all farm-level variation. The parallel nature of the farm-specific lines reflects our model assumption that the effect of soil pH does not vary across farms‚Äîan assumption we could relax if considering random <em>slopes</em> models.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Model Interpretation
</div>
</div>
<div class="callout-body-container callout-body">
<p>The fixed effect of soil pH represents the expected change in crop yield per unit increase in pH, averaged across all farms. The random intercepts capture farm-specific deviations from the population mean, representing unmeasured characteristics that make some farms systematically more or less productive than others. This decomposition allows us to make both farm-specific predictions (incorporating the farm‚Äôs baseline productivity) and population-level inferences (describing the typical relationship between pH and yield).</p>
</div>
</div>
</section>
</section>
</section>
<section id="faqs" class="level1">
<h1>FAQs</h1>
<section id="when-should-i-use-a-mixed-model-instead-of-traditional-regression" class="level3">
<h3 class="anchored" data-anchor-id="when-should-i-use-a-mixed-model-instead-of-traditional-regression"><em>When should I use a mixed model instead of traditional regression?</em></h3>
<p>Use mixed models when your data has a natural grouping or clustering structure and observations within groups are likely correlated. Examples include repeated measures on the same subjects, students within schools, or spatial clusters. You cannot just ignore this variation. If you ignore this structure, your standard errors will be wrong and your inferences invalid!</p>
</section>
<section id="im-working-in-rjulia-and-want-to-know-more-about-some-of-the-code-im-trying-to-use" class="level3">
<h3 class="anchored" data-anchor-id="im-working-in-rjulia-and-want-to-know-more-about-some-of-the-code-im-trying-to-use"><em>I‚Äôm working in R/Julia and want to know more about some of the code I‚Äôm trying to use</em></h3>
<p>You should check out the excellent documentation that exits for both resources. The <code>lme4</code> package has the <a href="https://cran.r-project.org/web/packages/lme4/lme4.pdf">docs</a> of course, but it also has a paper attached to it <span class="citation" data-cites="Bates-FittingLinearLme4-2014f">(<a href="#ref-Bates-FittingLinearLme4-2014f" role="doc-biblioref">Bates et al. 2014</a>)</span> which also may be helpful. The Julia <code>MixedModels.jl</code> <a href="https://juliastats.org/MixedModels.jl/stable/">docs</a> maintained by <span class="citation" data-cites="Alday-MixedModelsJl-2025v">Alday and Bates (<a href="#ref-Alday-MixedModelsJl-2025v" role="doc-biblioref">2025</a>)</span> are excellent.</p>
</section>
<section id="how-do-i-decide-what-to-include-as-random-effects" class="level3">
<h3 class="anchored" data-anchor-id="how-do-i-decide-what-to-include-as-random-effects"><em>How do I decide what to include as random effects?</em></h3>
<p>An age old question! Often, depending on what kind of inference you want to make, the same effects could be considered either fixed OR random. Start by identifying the grouping structure in your data. Include random intercepts for grouping factors where you expect baseline differences across groups. Be parsimonious: more complex random effects structures require more data to estimate reliably. A common rule of thumb is to have at least 5-10 groups per random effect parameter.</p>
</section>
<section id="i-have-a-random-effect-on-my-intercept-but-i-think-that-within-my-groups-the-relationship-between-my-fixed-effect-and-my-response-will-be-different.-what-should-i-do" class="level3">
<h3 class="anchored" data-anchor-id="i-have-a-random-effect-on-my-intercept-but-i-think-that-within-my-groups-the-relationship-between-my-fixed-effect-and-my-response-will-be-different.-what-should-i-do"><em>I have a random effect on my intercept, but I think that within my groups, the relationship between my fixed effect and my response will be different. What should I do?</em></h3>
<p>You are no longer talking about a fixed effect! That, referencing <a href="#fig-modeltypes" class="quarto-xref">Figure&nbsp;1</a>, you are now interested in a purely <em>random effects</em> model. Proceed with the fitting of the model the same way you would otherwise in most cases, after consulting a suitable text.</p>
</section>
<section id="whats-the-difference-between-ml-and-reml-estimation" class="level3">
<h3 class="anchored" data-anchor-id="whats-the-difference-between-ml-and-reml-estimation"><em>What‚Äôs the difference between ML and REML estimation?</em></h3>
<p>REML (Restricted Maximum Likelihood) is generally preferred because it produces unbiased estimates of variance components. However, you can‚Äôt use it for model comparison. Use ML when comparing models with different fixed effects structures using likelihood ratio tests, then refit the final model with REML. For comparing models with different random effects, either ML or REML is appropriate.</p>
</section>
<section id="what-if-i-dont-have-normal-data-e.g.-binomial-count-data-etc" class="level3">
<h3 class="anchored" data-anchor-id="what-if-i-dont-have-normal-data-e.g.-binomial-count-data-etc"><em>What if I don‚Äôt have normal data (e.g.&nbsp;binomial, count data, etc)?</em></h3>
<p>Then you‚Äôre looking for a generalized linear mixed-effects model (GLMM). The concepts underpining a GLMM are very similar with respect to the effects and the intuition, but require some extra care. Fitting them can be challenging, though many excellent resources exist to help you fit them out of the box. <span class="citation" data-cites="Bolker-GeneralizedLinearEvolution-2009o">Bolker et al. (<a href="#ref-Bolker-GeneralizedLinearEvolution-2009o" role="doc-biblioref">2009</a>)</span> is a very accessible introduction to the topic.</p>
</section>
<section id="how-do-i-assess-model-fit-for-mixed-models" class="level3">
<h3 class="anchored" data-anchor-id="how-do-i-assess-model-fit-for-mixed-models"><em>How do I assess model fit for mixed models?</em></h3>
<p>Unlike OLS regression, <span class="math inline">\(R^2\)</span> is more complex for mixed models. Use conditional <span class="math inline">\(R^2\)</span> (variance explained by fixed and random effects) and marginal <span class="math inline">\(R^2\)</span> (variance explained by fixed effects only). Information criteria (AIC, BIC) are useful for model comparison. For validation, consider cross-validation at the group level.</p>
</section>
<section id="can-i-include-both-spatial-and-temporal-correlation-structures" class="level3">
<h3 class="anchored" data-anchor-id="can-i-include-both-spatial-and-temporal-correlation-structures"><em>Can I include both spatial and temporal correlation structures?</em></h3>
<p>Yes, but this requires careful consideration. Packages like <code>nlme</code> in R allow you to specify complex correlation structures within groups. However, computational demands increase substantially. For spatiotemporal data, consider whether the spatial correlation is adequately captured by random effects or whether you need explicit correlation structures.</p>
</section>
</section>
<section id="references" class="level1">
<h1>References</h1>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Alday-MixedModelsJl-2025v" class="csl-entry" role="listitem">
Alday, Phillip M, and Douglas Bates. 2025. <span>‚Äú<span>MixedModels</span>.jl.‚Äù</span> Computer software. Zenodo. <a href="https://doi.org/10.5281/ZENODO.596435">https://doi.org/10.5281/ZENODO.596435</a>.
</div>
<div id="ref-Bates-FittingLinearLme4-2014f" class="csl-entry" role="listitem">
Bates, D, M Machler, B Bolker, and Steven C Walker. 2014. <span>‚ÄúFitting Linear Mixed-Effects Models Using <span class="nocase">lme4</span>.‚Äù</span> <em>Journal of Statistical Software</em> 67 (June): 1‚Äì48. <a href="https://doi.org/10.18637/JSS.V067.I01">https://doi.org/10.18637/JSS.V067.I01</a>.
</div>
<div id="ref-Bolker-GeneralizedLinearEvolution-2009o" class="csl-entry" role="listitem">
Bolker, Benjamin M, Mollie E Brooks, Connie J Clark, Shane W Geange, John R Poulsen, M Henry H Stevens, and Jada-Simone S White. 2009. <span>‚ÄúGeneralized Linear Mixed Models: A Practical Guide for Ecology and Evolution.‚Äù</span> <em>Trends in Ecology &amp; Evolution</em> 24 (March): 127‚Äì35. <a href="https://doi.org/10.1016/j.tree.2008.10.008">https://doi.org/10.1016/j.tree.2008.10.008</a>.
</div>
<div id="ref-Gelman-AnalysisVarianceEver-2005a" class="csl-entry" role="listitem">
Gelman, Andrew. 2005. <span>‚ÄúAnalysis of Variance - Why It Is More Important Than Ever.‚Äù</span> <em>Annals of Statistics</em> 33 (February): 1‚Äì53. <a href="https://doi.org/10.1214/009053604000001048">https://doi.org/10.1214/009053604000001048</a>.
</div>
<div id="ref-Midway-Chapter9Effects-2022x" class="csl-entry" role="listitem">
Midway, Steve. 2022. <span>‚ÄúChapter 9 Random Effects.‚Äù</span> July 13, 2022. <a href="https://bookdown.org/steve_midway/DAR/random-effects.html">https://bookdown.org/steve_midway/DAR/random-effects.html</a>.
</div>
</div>
<p><strong>Some Suggestions for Core Textbooks:</strong></p>
<ul>
<li>Gelman, Andrew, and Jennifer Hill. <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em>. Cambridge University Press, 2006.</li>
<li>Pinheiro, Jos√© C., and Douglas M. Bates. <em>Mixed-Effects Models in S and S-PLUS</em>. Springer, 2000.</li>
<li>Fitzmaurice, Garrett M., Nan M. Laird, and James H. Ware. <em>Applied Longitudinal Analysis</em>. 2nd ed.&nbsp;Wiley, 2011.</li>
<li>McCulloch, Charles E., and Shayle R. Searle. <em>Generalized, Linear, and Mixed Models</em>. Wiley, 2001.</li>
</ul>
</section>
<section id="appendix" class="level1">
<h1>Appendix</h1>
<section id="sec-reml" class="level2">
<h2 class="anchored" data-anchor-id="sec-reml">Appendix A - REML</h2>
<section id="restricted-maximum-likelihood-estimation" class="level3">
<h3 class="anchored" data-anchor-id="restricted-maximum-likelihood-estimation">Restricted Maximum Likelihood Estimation</h3>
<p>In the preceding discussion of the formalism underlying linear mixed-effects models, we referenced the profiled log-likelihood and the estimation of the variance-component parameter <span class="math inline">\(\theta\)</span>. We now examine more carefully the method by which these parameters are estimated, with particular attention to why the default approach in most modern software implementations is not ordinary maximum likelihood but rather restricted maximum likelihood, commonly abbreviated as REML.</p>
</section>
<section id="the-profiled-likelihood" class="level3">
<h3 class="anchored" data-anchor-id="the-profiled-likelihood">The Profiled Likelihood</h3>
<p>Before proceeding to REML, we must first understand what is meant by a ‚Äúprofiled‚Äù likelihood, as we referred to it above. When we fit a linear mixed-effects model, we are simultaneously estimating two types of parameters: the fixed effects <span class="math inline">\(\beta\)</span> and the variance components <span class="math inline">\(\theta\)</span>. The full likelihood function depends on both sets of parameters. However, for any given value of <span class="math inline">\(\theta\)</span>, we can analytically determine the value of <span class="math inline">\(\beta\)</span> that maximizes the likelihood. This process of maximizing over <span class="math inline">\(\beta\)</span> for each value of <span class="math inline">\(\theta\)</span> is called profiling, and it yields the profiled likelihood, which is a function of <span class="math inline">\(\theta\)</span> alone.</p>
<p>The computational advantage of this approach is substantial. Rather than searching through the <em>entire</em> high-dimensional space of all possible combinations of <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\theta\)</span>, we reduce the problem to a search over the typically much lower-dimensional space of <span class="math inline">\(\theta\)</span> values. For each candidate value of <span class="math inline">\(\theta\)</span> we consider, we can immediately compute the corresponding optimal <span class="math inline">\(\beta\)</span>. This profiled likelihood is what we actually optimize when fitting mixed-effects models, and the resulting estimate <span class="math inline">\(\hat{\theta}\)</span> then allows us to compute the corresponding <span class="math inline">\(\hat{\beta}\)</span>.</p>
</section>
<section id="the-motivation-for-reml" class="level3">
<h3 class="anchored" data-anchor-id="the-motivation-for-reml">The Motivation for REML</h3>
<p>Maximum likelihood estimation, while possessing many desirable theoretical properties, has a well-known deficiency when applied to variance components: the estimates tend to be biased downward. This irritating bias arises because maximum likelihood does not properly account for the degrees of freedom lost in estimating the fixed effects. The problem is perhaps most familiar in the simpler context of estimating a population variance from a sample, where we divide by <span class="math inline">\(n-1\)</span> rather than <span class="math inline">\(n\)</span> to obtain an unbiased estimate. The correction factor <span class="math inline">\(n-1\)</span> accounts for the fact that we had to estimate the mean from the data rather than knowing it a priori. The maximum likelihood estimate would use <span class="math inline">\(n\)</span> in the denominator and would consequently underestimate the true variance.</p>
<p>In mixed-effects models, this same phenomenon occurs but in a more complex form. When we estimate variance components using maximum likelihood, we are effectively using all <span class="math inline">\(n\)</span> observations without properly accounting for the <span class="math inline">\(p\)</span> degrees of freedom consumed by estimating the <span class="math inline">\(p\)</span> fixed effects in <span class="math inline">\(\beta\)</span>. The result is that variance components, particularly the residual variance <span class="math inline">\(\sigma^2\)</span>, tend to be underestimated. While this bias diminishes as the sample size grows large relative to the number of fixed effects, it can be consequential in finite samples, particularly when the number of fixed effects is substantial relative to the sample size.</p>
<p>Restricted maximum likelihood addresses this problem by basing inference on a transformed version of the data that does not depend on the fixed effects <span class="math inline">\(\beta\)</span>. Rather than maximizing the likelihood of the original data <span class="math inline">\(\mathbf{y}\)</span>, REML maximizes the likelihood of <span class="math inline">\(n-p\)</span> error contrasts, which are linear combinations of the data chosen such that they contain no information about <span class="math inline">\(\beta\)</span>. These contrasts can be thought of as generalized residuals that have had the fixed effects structure removed. By working with these contrasts rather than the raw data, REML properly accounts for the degrees of freedom used in estimating the fixed effects and produces less biased estimates of the variance components.</p>
</section>
<section id="the-reml-criterion" class="level3">
<h3 class="anchored" data-anchor-id="the-reml-criterion">The REML Criterion</h3>
<p>Mathematically, the REML estimate of <span class="math inline">\(\theta\)</span> is obtained by maximizing the restricted log-likelihood, which, though abhorent to look at, can be written should one desire as</p>
<p><span class="math display">\[\begin{equation}
\ell_R(\theta|\mathbf{y}) =
-\frac{1}{2}\left[\log|\Lambda_\theta^T\Lambda_\theta + \mathbf{I}| +
\log|\mathbf{X}^T\mathbf{X}| + (\mathbf{y} -
\mathbf{X}\hat{\beta}_\theta)^T(\Lambda_\theta^T\Lambda_\theta +
\sigma^2\mathbf{I})^{-1}(\mathbf{y} - \mathbf{X}\hat{\beta}_\theta)\right].
\end{equation}\]</span> If we can get over this equation‚Äôs initial hideous appearance, we can see that almost all of the components are ones we‚Äôve seen before. <span class="math inline">\(\hat{\beta}_\theta\)</span> denotes the conditional estimate of <span class="math inline">\(\beta\)</span> given <span class="math inline">\(\theta\)</span>. The second term, <span class="math inline">\(\log|\mathbf{X}^T\mathbf{X}|\)</span>, represents the penalty for having estimated the fixed effects, and it is this term that distinguishes REML from ordinary maximum likelihood. This penalty adjusts the likelihood to account for the uncertainty introduced by not knowing <span class="math inline">\(\beta\)</span> a priori.</p>
<p>The optimization of this restricted log-likelihood proceeds similarly to that of the profiled log-likelihood described earlier. We search over values of <span class="math inline">\(\theta\)</span>, and for each candidate value we can compute the corresponding estimates of all other quantities of interest. The computational machinery for REML is thus quite similar to that for maximum likelihood, differing primarily in the objective function being optimized.</p>
</section>
<section id="reml-versus-maximum-likelihood" class="level3">
<h3 class="anchored" data-anchor-id="reml-versus-maximum-likelihood">REML versus Maximum Likelihood</h3>
<p>Given that REML provides less biased estimates of variance components, one might wonder why maximum likelihood retains any role at all?! The answer lies in model comparison, which we only touch on briefly here. The REML criterion cannot be used to compare models with different fixed effects structures. This restriction arises because different fixed effects specifications effectively involve different linear transformations of the data, and the REML likelihoods under these different transformations are not directly comparable. It would be analogous to comparing the likelihood of your original data with the likelihood of some transformed version of your data. In short, we recommend:</p>
<ol type="1">
<li>Using classical maximum likelihood if you want to do model comparison with fixed effects structures</li>
<li>Once you‚Äôve identified your best model, refit it with REML</li>
</ol>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What do we mean by model comparison?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This limitation has important practical implications. When you wish to conduct a likelihood ratio test or compare AIC values to decide whether to include or exclude a particular fixed effect, you must refit your models using maximum likelihood rather than REML. The models can then be compared on the basis of their ML log-likelihoods, and once you have selected your fixed effects structure, you can refit the final model using REML to obtain the best estimates of the variance components.</p>
<p>REML remains perfectly suitable for comparing models with different random effects structures, provided the fixed effects remain constant. For example, if you are deciding whether to include random slopes in addition to random intercepts, you can fit both models with REML and compare them via likelihood ratio tests or information criteria. The fixed effects structure is the same in both models, so the REML likelihoods are comparable.</p>
</div>
</div>
</div>
<p>In summary, REML is the preferred estimation method for linear mixed-effects models when your primary interest is in obtaining accurate estimates of variance components and when you have already determined your fixed effects structure, which, in all of our examples herein, we will have done. Maximum likelihood remains necessary when you need to compare models that differ in their fixed effects. Most statistical software packages default to REML for precisely this reason, as it provides better finite-sample properties for the variance component estimates that are often of central interest in hierarchical data analysis.</p>
<!-- -->

</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb24" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Mixed-Effects Models: A Practical Guide"</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: "Cole Brookson"</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliation: "Epidemiology of Microbial Disease"</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co">    url: "https://github.com/colebrookson"</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "`r format(Sys.Date(), '%B %d, %Y')`"</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co">    html: </span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co">        code-fold: show</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co">        code-tools: true</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="co">        code-summary: "Show the code"</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> </span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co">    visual:</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="co">    render-on-save: true</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="an">engine:</span><span class="co"> julia</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="an">from:</span><span class="co"> markdown+emoji</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="an">links:</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="co">  - text: "StatLab"</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="co">    href: "https://yourinstitutionwebsite.com"</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="an">abstract:</span><span class="co"> |</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="co">  This research guide provides a comprehensive introduction to linear mixed-effects models. We begin with a discussion of the intuition behind mixed models, covering both theoretical foundations and practical implementation in R and Julia. Through a concrete example, we demonstrate how mixed models account for hierarchical data structures and within-group correlation.</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="an">about_author:</span><span class="co"> |</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="co">  Cole Brookson is a PhD candidate in the Department of Epidemiology of Microbial Disease.</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="an">keywords:</span><span class="co"> |</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="co">  mixed-effects models, hierarchical models, multilevel models, random effects, variance components, longitudinal data, clustered data, R, Julia, `lme4`, `MixedModels.jl`</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="an">bibliography:</span><span class="co"> mixed-effects-models.bib</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo = FALSE, eval = TRUE, message = FALSE}</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a><span class="in"># Load required packages</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a><span class="in">if (!require("pacman")) install.packages("pacman")</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="in">pacman::p_load(</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a><span class="in">    here, ggplot2, readr, JuliaCall</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a><span class="fu"># Introduction</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>In standard linear regression we are interested in estimating the relationship between one or more independent variable(s), $X$ (also known as predictors, explanatory variables, or *fixed* effects), and some dependent variable $Y$. However, often we encounter a fundamental problem early on in the analysis process when we recognize that, frustratingly, many datasets have hierarchical observation structures which are *not* independent (a requirement of simple linear regression). This non-independence can take many forms, but might be repeated measures on patients, measures on groups of students nested in schools, or experimental plots nested in different study fields. To deal with this challenge, researchers typically turn to an approach we call a **mixed-effects model**, which is an extension of a standard linear model as described above, typically containing only fixed effects. The key addition is the notion of a **random effect**, defined below, which allows for the accounting of within-group correlation, while also facilitating inference about both group-specific and population-level effects.</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>To define a mixed-effects model, we can introduce a new concept, known as a **random effect** (also known as a **varying effect**). However, we immediately find ourselves in definition jail with respect to what, specifically, a **random effect** means relative to a **fixed effect**.</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a><span class="fu">## Definition</span></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>Mixed-effects models in this context are models that include both (1) fixed effects, and (2) random effects. The definitions for such terms have been fought over in the literature for decades, but here we follow the definition of @Gelman-AnalysisVarianceEver-2005a, such that *fixed effects* are used to mean the effects or coefficients that are identical for all groups in a population, and *random effects* are those which are allowed to differ from group to group.</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>We will explain further what we mean by this, but aim to put this warning front and centre should someone be looking for a "mixed-effects" model containing the type of "fixed effect" often referred to econometrics literature that has an entirely different interpretation.</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>In this guide we'll go over the formalism behind this kind of approach, when it's useful, and how to implement a mixed-effects model in common programming languages.</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>\begin{tex}</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>\begin{figure}</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>\input{images/midway-model-types.png}</span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>\end{figure}</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>\end{tex}</span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a><span class="al">![Types of "effect" models. Image from @Midway-Chapter9Effects-2022x](images/midway-model-types.png)</span>{#fig-modeltypes}</span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>We'll also focus mainly on mixed-effects models with random intercepts, but will discuss the existence briefly of random slopes, and thus, random effects models. The formulation will be consistent with the classic frequentist approach &amp; language. We assume you're familiar with the representation of fixed effects and simple linear regression in @fig-modeltypes.</span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a><span class="fu"># Methods</span></span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a><span class="fu">## Theoretical Intuition</span></span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a>Imagine we're conducting a study investigating the effect of soil pH on crop yield. We have a number of experimental plots, which are nested within farms across different regions. Since each farm contributes multiple plots, we end up with a hierarchical data structure where observations within farms cannot be assumed independent. The set-up, visually, may look something like this:</span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a><span class="in">%%| fig-width: 15</span></span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a><span class="in">%%| fig-height: 10</span></span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a><span class="in">%%| fig-cap: "Nested plots within farms across different regions."</span></span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a><span class="in">%%| label: fig-nested-farms</span></span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a><span class="in">graph TD</span></span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a><span class="in">    Farm1[Farm 1]:::farm1</span></span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a><span class="in">    Farm2[Farm 2]:::farm2</span></span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a><span class="in">    Farm3[Farm 3]:::farm3</span></span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a><span class="in">    Farm1 --&gt; P1[Plot 1]:::plot</span></span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a><span class="in">    Farm1 --&gt; P2[Plot 2]:::plot</span></span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a><span class="in">    Farm1 --&gt; P3[Plot 3]:::plot</span></span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a><span class="in">    Farm1 --&gt; P4[Plot 4]:::plot</span></span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a><span class="in">    Farm1 --&gt; P5[Plot 5]:::plot</span></span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a><span class="in">    Farm2 --&gt; P6[Plot 6]:::plot</span></span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a><span class="in">    Farm2 --&gt; P7[Plot 7]:::plot</span></span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a><span class="in">    Farm2 --&gt; P8[Plot 8]:::plot</span></span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a><span class="in">    Farm2 --&gt; P9[Plot 9]:::plot</span></span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a><span class="in">    Farm2 --&gt; P10[Plot 10]:::plot</span></span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a><span class="in">    Farm3 --&gt; P11[Plot 11]:::plot</span></span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a><span class="in">    Farm3 --&gt; P12[Plot 12]:::plot</span></span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a><span class="in">    Farm3 --&gt; P13[Plot 13]:::plot</span></span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a><span class="in">    Farm3 --&gt; P14[Plot 14]:::plot</span></span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a><span class="in">    Farm3 --&gt; P15[Plot 15]:::plot</span></span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef farm1 fill:#DEB887,stroke:#8B4513,stroke-width:5px,color:#000</span></span>
<span id="cb24-102"><a href="#cb24-102" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef farm2 fill:#F4A460,stroke:#A0522D,stroke-width:5px,color:#000</span></span>
<span id="cb24-103"><a href="#cb24-103" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef farm3 fill:#D2B48C,stroke:#8B7355,stroke-width:5px,color:#000</span></span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a><span class="in">    classDef plot fill:#FFFFFF,stroke:#000000,stroke-width:4px,color:#000</span></span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-106"><a href="#cb24-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-107"><a href="#cb24-107" aria-hidden="true" tabindex="-1"></a>This is exactly the use case for something like mixed-effects models. Such an approach allows us to account for within-group correlation while doing inference about both group-specific and population-level effects. To formalize this, say our simple linear model is</span>
<span id="cb24-108"><a href="#cb24-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-109"><a href="#cb24-109" aria-hidden="true" tabindex="-1"></a><span class="in">```{=tex}</span></span>
<span id="cb24-110"><a href="#cb24-110" aria-hidden="true" tabindex="-1"></a><span class="in">\begin{equation}</span></span>
<span id="cb24-111"><a href="#cb24-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-112"><a href="#cb24-112" aria-hidden="true" tabindex="-1"></a><span class="in">Y_{ij} = \beta_0 + \beta_1 x_{ij} + \epsilon_{ij}</span></span>
<span id="cb24-113"><a href="#cb24-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-114"><a href="#cb24-114" aria-hidden="true" tabindex="-1"></a><span class="in">\end{equation}</span></span>
<span id="cb24-115"><a href="#cb24-115" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-116"><a href="#cb24-116" aria-hidden="true" tabindex="-1"></a>where we have measurements of crop yield, $y_{ij}$ in plots $i$, nested within farm $j$, as well as some soil pH levels, $x_{ij}$. It follows that we may want to understand if there is some effect of the fixed effect soil pH on the crop yield. That is, we might want to do some form of standard linear regression to learn about our $\beta$ values. But, we're faced with the possibility that each farm has characteristics specific to itself that may influence the crop yield. This could be a variety of different features, but often we can assume that some or all of them are unobserved.</span>
<span id="cb24-117"><a href="#cb24-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-118"><a href="#cb24-118" aria-hidden="true" tabindex="-1"></a>Therefore, we can use a **random effect** to help control for this unobserved dependence.</span>
<span id="cb24-119"><a href="#cb24-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-120"><a href="#cb24-120" aria-hidden="true" tabindex="-1"></a><span class="fu">### Random Effects {#sec-raneffs}</span></span>
<span id="cb24-121"><a href="#cb24-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-122"><a href="#cb24-122" aria-hidden="true" tabindex="-1"></a>In the most general sense, assume that there is some variable which takes $k$ possible values and is related to a response variable via a regression model. If there is some linear predictor that can be generated from this, we could construct the model (with no fixed effect) as $$Y_{ij} = \beta_0 + \alpha_j + \epsilon_{ij}$$ with $j = 1, ..., k-1$, where $i$ indexes the possible values of the explanatory variable, and $\epsilon$ is some error term. In our example, we consider $j$ to be indicators of which farm our samples are coming from. These $\alpha_j$'s are referred to as random effects if they can be thought to arise from some random sample of a distribution, independent and identically distributed (i.i.d.) $$\alpha_j \mathop\sim^{i.i.d.} N(0, \sigma^{2}_{\alpha}).$$ This looks very similar to a fixed effects model, but importantly, in the frequentist space, we consider fixed effects to be *fixed, unknown parameters*, whereas these are (of course), random. This means that with our simple model, we have the expected value of $Y_{ij}$ being $$E[Y_{ij}] = \beta_0,$$ and the variance is $$Var(Y_{ij}) = \sigma_{\alpha}^2 + \sigma^2.$$ Importantly, we're then left with a correlation structure </span>
<span id="cb24-123"><a href="#cb24-123" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb24-124"><a href="#cb24-124" aria-hidden="true" tabindex="-1"></a>\text{Cor}(Y_{ij},Y_{kl}) = </span>
<span id="cb24-125"><a href="#cb24-125" aria-hidden="true" tabindex="-1"></a>\begin{cases}</span>
<span id="cb24-126"><a href="#cb24-126" aria-hidden="true" tabindex="-1"></a>0&amp; i\neq k <span class="sc">\\</span></span>
<span id="cb24-127"><a href="#cb24-127" aria-hidden="true" tabindex="-1"></a>\sigma^2_{\alpha}/(\sigma^2_{\alpha} + \sigma^2)&amp; i=k,j \neq l <span class="sc">\\</span></span>
<span id="cb24-128"><a href="#cb24-128" aria-hidden="true" tabindex="-1"></a>1&amp; i = k, j = l</span>
<span id="cb24-129"><a href="#cb24-129" aria-hidden="true" tabindex="-1"></a>\end{cases}</span>
<span id="cb24-130"><a href="#cb24-130" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb24-131"><a href="#cb24-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-132"><a href="#cb24-132" aria-hidden="true" tabindex="-1"></a>What this correlation structure tells us is essential for interpreting random effects. Essentially, observations from *different* farms (the $i \neq k$ case) are uncorrelated, while observations from the *same* farm ($i=k$ case) are indeed correlated. This form of correlation has a few different terms, but we follow the common term of **intraclass correlation (ICC)**, and is given as in the above equation, as $\sigma^2_{\alpha}/(\sigma^2_{\alpha} + \sigma^2)$. If the ICC is large, observations from the *same farm* are much more similar than observations from *different farms*. </span>
<span id="cb24-133"><a href="#cb24-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-134"><a href="#cb24-134" aria-hidden="true" tabindex="-1"></a><span class="fu">### Random Intercepts Model</span></span>
<span id="cb24-135"><a href="#cb24-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-136"><a href="#cb24-136" aria-hidden="true" tabindex="-1"></a>Now that we have a foundation of a *random effect*, let us consider them in the context where there is also a fixed effect that we wish to estimate. The model, as we wrote it before, will now include our single fixed effect of interest, and our random effect of farm. </span>
<span id="cb24-137"><a href="#cb24-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-138"><a href="#cb24-138" aria-hidden="true" tabindex="-1"></a>$$Y_{ij} = \beta_0 + \beta_1 X_{ij} + \alpha_j + \epsilon_{ij}$$ </span>
<span id="cb24-139"><a href="#cb24-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-140"><a href="#cb24-140" aria-hidden="true" tabindex="-1"></a>This is to be interpreted, in plain english, as a simple linear mixed-effects model with a fixed effect of soil pH, and a random effect on farm. In this formulation, we are assuming that our random effect takes the form of a **random intercept**. Which is to say, we assume the relationship between soil pH and yield to operates with the same form in each place, but that there are likely differences in soil pH generally between farm locations. So the per-unit change of $X_{ij}$ leads to the same per-unit change in $Y_{ij}$, and therefore we can estimate one population-level $\beta$ value. Let's visualize this:</span>
<span id="cb24-141"><a href="#cb24-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-142"><a href="#cb24-142" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=FALSE,message=FALSE}</span></span>
<span id="cb24-143"><a href="#cb24-143" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-soil-data</span></span>
<span id="cb24-144"><a href="#cb24-144" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Simulated data for this example, coloured by farm."</span></span>
<span id="cb24-145"><a href="#cb24-145" aria-hidden="true" tabindex="-1"></a><span class="in">field_data &lt;- read_csv(</span></span>
<span id="cb24-146"><a href="#cb24-146" aria-hidden="true" tabindex="-1"></a><span class="in">    here::here("./research-guides/mixed-effects-models/data/crop_yield_data.csv"),</span></span>
<span id="cb24-147"><a href="#cb24-147" aria-hidden="true" tabindex="-1"></a><span class="in">    show_col_types = FALSE</span></span>
<span id="cb24-148"><a href="#cb24-148" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb24-149"><a href="#cb24-149" aria-hidden="true" tabindex="-1"></a><span class="in">field_data$farm_id &lt;- as.factor(field_data$farm_id)</span></span>
<span id="cb24-150"><a href="#cb24-150" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(data = field_data) +</span></span>
<span id="cb24-151"><a href="#cb24-151" aria-hidden="true" tabindex="-1"></a><span class="in">    geom_point(aes(x = soil_pH, y = yield, colour = farm_id)) +</span></span>
<span id="cb24-152"><a href="#cb24-152" aria-hidden="true" tabindex="-1"></a><span class="in">    theme_bw() +</span></span>
<span id="cb24-153"><a href="#cb24-153" aria-hidden="true" tabindex="-1"></a><span class="in">    labs(x = "Soil pH", y = "Crop Yield") +</span></span>
<span id="cb24-154"><a href="#cb24-154" aria-hidden="true" tabindex="-1"></a><span class="in">    scale_colour_manual("Farm ID", values = MoMAColors::moma.colors("OKeeffe"))</span></span>
<span id="cb24-155"><a href="#cb24-155" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-156"><a href="#cb24-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-157"><a href="#cb24-157" aria-hidden="true" tabindex="-1"></a>In @fig-soil-data we can clearly see that there is a discernable relationship between points of the same colour, but, at least looking at it, we can see that the the relationship between the two variables are probably linear. We can preview what will come out of our analysis by putting some lines through each set of points. </span>
<span id="cb24-158"><a href="#cb24-158" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,message=FALSE}</span></span>
<span id="cb24-159"><a href="#cb24-159" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb24-160"><a href="#cb24-160" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-soil-data-lm</span></span>
<span id="cb24-161"><a href="#cb24-161" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Simulated data for this example, coloured by farm, with a simple line of best fit, grouped by farm."</span></span>
<span id="cb24-162"><a href="#cb24-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-163"><a href="#cb24-163" aria-hidden="true" tabindex="-1"></a><span class="in"># we'll show how to read in this data example later on!</span></span>
<span id="cb24-164"><a href="#cb24-164" aria-hidden="true" tabindex="-1"></a><span class="in">ggplot(data = field_data) +</span></span>
<span id="cb24-165"><a href="#cb24-165" aria-hidden="true" tabindex="-1"></a><span class="in">    geom_point(aes(x = soil_pH, y = yield, colour = farm_id)) +</span></span>
<span id="cb24-166"><a href="#cb24-166" aria-hidden="true" tabindex="-1"></a><span class="in">    geom_smooth(</span></span>
<span id="cb24-167"><a href="#cb24-167" aria-hidden="true" tabindex="-1"></a><span class="in">        aes(</span></span>
<span id="cb24-168"><a href="#cb24-168" aria-hidden="true" tabindex="-1"></a><span class="in">            x = soil_pH, y = yield,</span></span>
<span id="cb24-169"><a href="#cb24-169" aria-hidden="true" tabindex="-1"></a><span class="in">            group = farm_id, colour = farm_id</span></span>
<span id="cb24-170"><a href="#cb24-170" aria-hidden="true" tabindex="-1"></a><span class="in">        ),</span></span>
<span id="cb24-171"><a href="#cb24-171" aria-hidden="true" tabindex="-1"></a><span class="in">        method = lm</span></span>
<span id="cb24-172"><a href="#cb24-172" aria-hidden="true" tabindex="-1"></a><span class="in">    ) +</span></span>
<span id="cb24-173"><a href="#cb24-173" aria-hidden="true" tabindex="-1"></a><span class="in">    theme_bw() +</span></span>
<span id="cb24-174"><a href="#cb24-174" aria-hidden="true" tabindex="-1"></a><span class="in">    labs(x = "Soil pH", y = "Crop Yield") +</span></span>
<span id="cb24-175"><a href="#cb24-175" aria-hidden="true" tabindex="-1"></a><span class="in">    scale_colour_manual("Farm ID", values = MoMAColors::moma.colors("OKeeffe"))</span></span>
<span id="cb24-176"><a href="#cb24-176" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-177"><a href="#cb24-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-178"><a href="#cb24-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-179"><a href="#cb24-179" aria-hidden="true" tabindex="-1"></a>There are some obvious differences here in @fig-soil-data-lm, and it *appears* as though perhaps the intercepts for the different farms might be different. Having done this brief visualization, let's look at how we can actually estimate our model. </span>
<span id="cb24-180"><a href="#cb24-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-181"><a href="#cb24-181" aria-hidden="true" tabindex="-1"></a><span class="fu">## Formalism</span></span>
<span id="cb24-182"><a href="#cb24-182" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb24-183"><a href="#cb24-183" aria-hidden="true" tabindex="-1"></a>If you don't especially care about how all of this works under the hood, but have read up to this point, you can probably safely skip to <span class="co">[</span><span class="ot">Implementation</span><span class="co">](@sec-implementation)</span> section below :grin:.</span>
<span id="cb24-184"><a href="#cb24-184" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-185"><a href="#cb24-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-186"><a href="#cb24-186" aria-hidden="true" tabindex="-1"></a>So that we do not lose generality, let us consider the model where there are two random variables: $\mathcal{Y}$, the $n$-dimensional vector of responses, and $\mathcal{B}$, the $q$-dimensional vector of random *effects*. We of course observe some value of $\mathcal{Y}$, which we note as $\mathbf{y}$, but based on how we [defined a random effect as a random variable](@sec-raneffs), we definitionally do **not** observe the value $\mathbf{b}$ of $\mathcal{B}$. </span>
<span id="cb24-187"><a href="#cb24-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-188"><a href="#cb24-188" aria-hidden="true" tabindex="-1"></a>The unconditional distribution of $\mathcal{B}$ (that is, the distribution before we observe any data) is given by $\mathcal{B}\sim\mathcal{N}(\mathbf{0},\Sigma_\theta)$, where $\Sigma_\theta$ is a variance-covariance matrix that depends on our variance-component parameter, $\theta$. The variance-component parameter $\theta$ controls how much variation we expect to see in our random effects. In the simplest case of a random intercept model, $\theta$ might be a single number that determines the standard deviation of the random intercepts. In our soil pH example, this would control how much we expect the baseline crop yield to vary from field to field. In more complex models, $\theta$ can be a vector of multiple parameters that control not just the variance of different random effects, but also how they covary with each other. For instance, if we had both random intercepts and random slopes for pH effect by field, $\theta$ would include parameters controlling the variance of intercepts, the variance of slopes, and the correlation between them.</span>
<span id="cb24-189"><a href="#cb24-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-190"><a href="#cb24-190" aria-hidden="true" tabindex="-1"></a>In this case, we end up with a linear predictor $\mathbf{X}\beta + \mathbf{Z}\mathbf{b}$, which is the conditional mean of $\mathcal{Y}$, given $\mathcal{B} = \mathbf{b}$. Since we are dealing with the linear mixed-effects model case for now, the conditional distribution $(\mathcal{Y}|\mathcal{B}=\mathbf{b})$ is given by </span>
<span id="cb24-191"><a href="#cb24-191" aria-hidden="true" tabindex="-1"></a>$$ (\mathcal{Y}|\mathcal{B}=\mathbf{b}) \sim \mathcal{N}(\mathbf{X}\beta + \mathbf{Z}\mathbf{b}, \sigma^2 \mathbf{I}),$$ </span>
<span id="cb24-192"><a href="#cb24-192" aria-hidden="true" tabindex="-1"></a>where $\mathbf{I}$ is the identity matrix.</span>
<span id="cb24-193"><a href="#cb24-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-194"><a href="#cb24-194" aria-hidden="true" tabindex="-1"></a>To make the computational machinery work more efficiently, we introduce what are called **spherical random effects**, denoted $\mathcal{U}$. The term "spherical" here refers to random effects that have been standardized so that they have no correlation with each other and all have the same variance. Think of this as similar to converting raw test scores to z-scores. These spherical random effects are related to our actual random effects through the transformation $$\mathcal{B}=\Lambda_\theta\mathcal{U},$$ where $\Lambda_\theta$ is called the relative covariance factor. This transformation essentially allows us to work with a simpler, standardized version of the problem during computation, then transform back to get results on the original scale. In our soil pH example, if we had random effects for different fields that were correlated (perhaps because nearby fields share soil characteristics), the spherical random effects would represent a transformed version where those correlations have been removed.</span>
<span id="cb24-195"><a href="#cb24-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-196"><a href="#cb24-196" aria-hidden="true" tabindex="-1"></a>This is where the rubber meets the road computationally. We arrive at the challenge of computing the maximum likelihood estimation of the variance-component parameter $\theta$, which we term $\hat{\theta}$, that minimizes what is called the profiled log-likelihood. The actual value of $\hat{\theta}$ is obtained through numerical optimization, the details of which will depend on the software package at hand. In the process of evaluating our profiled log-likelihood and finding this optimal $\hat{\theta}$, we simultaneously obtain several other quantities: $\hat{\beta}$, which is our estimate for the coefficients of the fixed effects, and $\tilde{\mathbf{u}}_{\hat{\theta}}$, which is the conditional mode of the spherical random effects $\mathcal{U}$ (that is, the value of $\mathbf{u}$ that is most likely given the data we observed). </span>
<span id="cb24-197"><a href="#cb24-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-198"><a href="#cb24-198" aria-hidden="true" tabindex="-1"></a>We then transform these conditional modes of the spherical random effects back to the original scale of our random effects using </span>
<span id="cb24-199"><a href="#cb24-199" aria-hidden="true" tabindex="-1"></a>$$\tilde{\mathbf{b}}_{\hat{\theta}} = \Lambda_{\hat{\theta}}\tilde{\mathbf{u}}_{\hat{\theta}}.$$</span>
<span id="cb24-200"><a href="#cb24-200" aria-hidden="true" tabindex="-1"></a>These values $\tilde{\mathbf{b}}_{\hat{\theta}}$ represent the values of $\mathbf{b}$ that maximize the density of the conditional distribution $\mathcal{B}|\mathcal{Y} = \mathbf{y}$. In plain language, these are our best guesses for the random effect values given the data we actually observed. You will often see these called the **best linear unbiased predictors** (BLUPs) or conditional modes. In our soil pH example, these would be the estimated effect of each specific field on crop yield. For a linear mixed model where all distributions are Gaussian (normal), these conditional modes are also equal to the conditional means, which is a convenient mathematical property.</span>
<span id="cb24-201"><a href="#cb24-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-202"><a href="#cb24-202" aria-hidden="true" tabindex="-1"></a><span class="fu">## Estimation via (Restricted) Maximum Likelihood </span></span>
<span id="cb24-203"><a href="#cb24-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-204"><a href="#cb24-204" aria-hidden="true" tabindex="-1"></a>When we use mixed-effects models, we often fit the models via a maximum liklihood estimation proceedure, with the most common form of it being restricted maximum liklihood (REML). More details about this method along with some notes ot pay attention to are in the <span class="co">[</span><span class="ot">appendix on REML</span><span class="co">](@sec-reml)</span></span>
<span id="cb24-205"><a href="#cb24-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-206"><a href="#cb24-206" aria-hidden="true" tabindex="-1"></a>Why restricted? Maximum likelihood estimation of variance components in mixed-effects models suffers from a well-known deficiency: the estimates are biased downward because the procedure fails to account for the degrees of freedom consumed in estimating the fixed effects, much as the sample variance requires division by $n-1$ rather than $n$ to correct for the estimation of the mean. Restricted maximum likelihood remedies this problem by basing inference on $n-p$ error contrasts‚Äîlinear combinations of the data that contain no information about the fixed effects‚Äîthereby properly accounting for the uncertainty introduced by estimating $\beta$. While REML produces less biased estimates of variance components and is thus preferred for final model fitting, it cannot be used to compare models with different fixed effects structures, as the restricted likelihoods under different fixed effects specifications involve different transformations of the data and are therefore not comparable. Consequently, the recommended practice is to use ordinary maximum likelihood when selecting among competing fixed effects structures via likelihood ratio tests or information criteria, and then to refit the chosen model using REML to obtain optimal estimates of the variance components.</span>
<span id="cb24-207"><a href="#cb24-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-208"><a href="#cb24-208" aria-hidden="true" tabindex="-1"></a><span class="fu">## Assumptions </span></span>
<span id="cb24-209"><a href="#cb24-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-210"><a href="#cb24-210" aria-hidden="true" tabindex="-1"></a>Many of the assumptions of a linear mixed effect model are the same as a standard linear model, which are covered in the <span class="co">[</span><span class="ot">OLS regression research guide</span><span class="co">](LINK)</span>. Briefly, the most important assumptions are: </span>
<span id="cb24-211"><a href="#cb24-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-212"><a href="#cb24-212" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Linearity:** The relationships between the predictors and the response variable are linear</span>
<span id="cb24-213"><a href="#cb24-213" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Independence of residuals:** Conditional on the fixed and random effects, the residuals are independent of each other.</span>
<span id="cb24-214"><a href="#cb24-214" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Normality of residuals:**  The residuals are normally distributed.</span>
<span id="cb24-215"><a href="#cb24-215" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Constant variance of residuals (Homoscedasticity):** The spread of the residuals is consistent across all levels of the predictors.</span>
<span id="cb24-216"><a href="#cb24-216" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**No multicollinearity:** The independent variables are not strongly correlated with one another.</span>
<span id="cb24-217"><a href="#cb24-217" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Normal distribution of random effects:** The random effects are assumed to be normally distributed</span>
<span id="cb24-218"><a href="#cb24-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-219"><a href="#cb24-219" aria-hidden="true" tabindex="-1"></a>Checking these (mostly) occurs after the model is fit or at the experimental design stage, so we'll focus exclusively on the assumptions that can be checked once a model has been fit or during the fitting process. </span>
<span id="cb24-220"><a href="#cb24-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-221"><a href="#cb24-221" aria-hidden="true" tabindex="-1"></a><span class="fu"># Implementation {#sec-implementation}</span></span>
<span id="cb24-222"><a href="#cb24-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-223"><a href="#cb24-223" aria-hidden="true" tabindex="-1"></a>In this section we go over how to actually *fit* these models in programatic softwares. </span>
<span id="cb24-224"><a href="#cb24-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-225"><a href="#cb24-225" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb24-226"><a href="#cb24-226" aria-hidden="true" tabindex="-1"></a><span class="fu">## With Great (Computational) Power Comes Great Responsibility</span></span>
<span id="cb24-227"><a href="#cb24-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-228"><a href="#cb24-228" aria-hidden="true" tabindex="-1"></a>Modern statistical softwares, as you are about to see, have come a *long* way in terms of making computing these actually very complex models, *very* easy. One can fit a linear mixed-effects model in R in as few as 10 lines of code. **We wish to stress that this simplicity of implementation is not to be confused with simplicity of the method.** </span>
<span id="cb24-229"><a href="#cb24-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-230"><a href="#cb24-230" aria-hidden="true" tabindex="-1"></a>There are a lot of important details going on under the hood, and it is any responsible researcher's duty to ensure that they themselves are sufficiently aware of the eccentricites of their own data, model, and software to reliably interpret results. Just because the code ran doesn't mean your answer is correct, and it is almost always worth reading the excellent documentation for whatever methods you're using (in this case, the <span class="co">[</span><span class="ot">`lme4`</span><span class="co">](https://cran.r-project.org/web/packages/lme4/lme4.pdf)</span> package for R and the <span class="co">[</span><span class="ot">`MixedModels.jl`</span><span class="co">](https://juliastats.org/MixedModels.jl/dev/)</span> package for Julia.) </span>
<span id="cb24-231"><a href="#cb24-231" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-232"><a href="#cb24-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-233"><a href="#cb24-233" aria-hidden="true" tabindex="-1"></a><span class="fu">## Random Intercepts Model </span></span>
<span id="cb24-234"><a href="#cb24-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-235"><a href="#cb24-235" aria-hidden="true" tabindex="-1"></a>Recall our soil pH and crop yield example where we showed a quick plot in @fig-soil-data-lm indicating that there were almost certainly differences between our farms in terms of their intercepts. So, we can simply fit a linear mixed-effects model, with the goal of estimating a (fixed) effect of soil pH on crop yield (i.e., what is the "slope" of the relationship), and a random effect on the intercept (i.e., what are the intercepts of each farm). Quickly, let's set up our model. </span>
<span id="cb24-236"><a href="#cb24-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-237"><a href="#cb24-237" aria-hidden="true" tabindex="-1"></a>In our soil pH example, our statistical model is $$Y_{ij} = \beta_0 + \beta_1 X_{ij} + \alpha_{j} + \epsilon_{ij}$$ where $Y_{ij}$ is the measurement of crop yeild at plot $i$ in farm $j$, $\beta_0$ is our population-level intercept, $\beta_1$ is the to-be-estimated effect or coefficient of $X_{ij}$, the measurement of soil pH at plot $i$ in farm $j$, $\alpha_j$ is the random effect on the intercept for each group (farm), $j$, and then $\epsilon$ is our error term. </span>
<span id="cb24-238"><a href="#cb24-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-239"><a href="#cb24-239" aria-hidden="true" tabindex="-1"></a>We need to translate this into code. In these languages, we use what's called a *formula* to describe our statistical model. The general form of that formula is: </span>
<span id="cb24-240"><a href="#cb24-240" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb24-241"><a href="#cb24-241" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: false</span></span>
<span id="cb24-242"><a href="#cb24-242" aria-hidden="true" tabindex="-1"></a><span class="in">response ~ 1 + fixed_effect + (1|random_intercept)</span></span>
<span id="cb24-243"><a href="#cb24-243" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-244"><a href="#cb24-244" aria-hidden="true" tabindex="-1"></a>where we can add arbitrarily many fixed effects, e.g., </span>
<span id="cb24-245"><a href="#cb24-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-246"><a href="#cb24-246" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb24-247"><a href="#cb24-247" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: false</span></span>
<span id="cb24-248"><a href="#cb24-248" aria-hidden="true" tabindex="-1"></a><span class="in">response ~ 1 + fixed_effect_1 + fixed_effect_2 + (1|random_intercept_1) + (1|random_intercept_2)</span></span>
<span id="cb24-249"><a href="#cb24-249" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-250"><a href="#cb24-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-251"><a href="#cb24-251" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb24-252"><a href="#cb24-252" aria-hidden="true" tabindex="-1"></a>Here, in our formula, you'll notice we have this <span class="in">`... ~ 1 + ...`</span> hanging out in the middle. This explicitly indicatess the presence of an intercept term in the model (i.e. the code-equivalent of $\beta_0$ in our model equation). In most statistical software packages, it's assumed that an intercept will be present, since models without them are rare. </span>
<span id="cb24-253"><a href="#cb24-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-254"><a href="#cb24-254" aria-hidden="true" tabindex="-1"></a>The interpretation of the intercept in this case is the intercept would represent the expected crop yield when pH equals zero (which would be nonsensical in practice, but that is its mathematical interpretation). The model would estimate this baseline value along with the effect of changing pH. In most formula interfaces, including R and Julia's, **an intercept is included by default even if you don't write one**. This means that <span class="in">`response ~ fixed_effect`</span> and <span class="in">`response ~ 1 + fixed_effect`</span> are equivalent and both include an intercept. Here, we believe it's optional, but will always include it for clarity, and encourage others to do the same. </span>
<span id="cb24-255"><a href="#cb24-255" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-256"><a href="#cb24-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-257"><a href="#cb24-257" aria-hidden="true" tabindex="-1"></a>Now, to some code! Let's first get a sense of what our data actually look like for this example. </span>
<span id="cb24-258"><a href="#cb24-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-259"><a href="#cb24-259" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb24-260"><a href="#cb24-260" aria-hidden="true" tabindex="-1"></a><span class="fu">### R</span></span>
<span id="cb24-261"><a href="#cb24-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-264"><a href="#cb24-264" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb24-265"><a href="#cb24-265" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb24-266"><a href="#cb24-266" aria-hidden="true" tabindex="-1"></a><span class="co"># some set up! </span></span>
<span id="cb24-267"><a href="#cb24-267" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb24-268"><a href="#cb24-268" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb24-269"><a href="#cb24-269" aria-hidden="true" tabindex="-1"></a><span class="co"># load in the data from our local location </span></span>
<span id="cb24-270"><a href="#cb24-270" aria-hidden="true" tabindex="-1"></a>field_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb24-271"><a href="#cb24-271" aria-hidden="true" tabindex="-1"></a>    <span class="fu">here</span>(<span class="st">"./research-guides/mixed-effects-models/data/crop_yield_data.csv"</span>),</span>
<span id="cb24-272"><a href="#cb24-272" aria-hidden="true" tabindex="-1"></a>    <span class="at">show_col_types =</span> <span class="cn">FALSE</span></span>
<span id="cb24-273"><a href="#cb24-273" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-274"><a href="#cb24-274" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(field_data)</span>
<span id="cb24-275"><a href="#cb24-275" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-276"><a href="#cb24-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-277"><a href="#cb24-277" aria-hidden="true" tabindex="-1"></a><span class="fu">### Julia</span></span>
<span id="cb24-278"><a href="#cb24-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-281"><a href="#cb24-281" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-282"><a href="#cb24-282" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: false</span></span>
<span id="cb24-283"><a href="#cb24-283" aria-hidden="true" tabindex="-1"></a><span class="in"># some set up! </span></span>
<span id="cb24-284"><a href="#cb24-284" aria-hidden="true" tabindex="-1"></a><span class="in">using DataFrames, CSV, Base.Filesystem</span></span>
<span id="cb24-285"><a href="#cb24-285" aria-hidden="true" tabindex="-1"></a><span class="in">#  project_root = @__DIR__ # if we need to double check where the directory is pointing rn </span></span>
<span id="cb24-286"><a href="#cb24-286" aria-hidden="true" tabindex="-1"></a><span class="in"># load the data from local location</span></span>
<span id="cb24-287"><a href="#cb24-287" aria-hidden="true" tabindex="-1"></a><span class="in">field_data = CSV.read(</span></span>
<span id="cb24-288"><a href="#cb24-288" aria-hidden="true" tabindex="-1"></a><span class="in">    joinpath(@__DIR__, "./data/crop_yield_data.csv"),</span></span>
<span id="cb24-289"><a href="#cb24-289" aria-hidden="true" tabindex="-1"></a><span class="in">    DataFrame</span></span>
<span id="cb24-290"><a href="#cb24-290" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb24-291"><a href="#cb24-291" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-292"><a href="#cb24-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-293"><a href="#cb24-293" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-294"><a href="#cb24-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-295"><a href="#cb24-295" aria-hidden="true" tabindex="-1"></a>We're dealing with clean data in this case, so we're skipping some common data cleaning steps that may normally come here. </span>
<span id="cb24-296"><a href="#cb24-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-297"><a href="#cb24-297" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fitting the model </span></span>
<span id="cb24-298"><a href="#cb24-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-299"><a href="#cb24-299" aria-hidden="true" tabindex="-1"></a>Without further ado, let's actually fit our models. </span>
<span id="cb24-300"><a href="#cb24-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-301"><a href="#cb24-301" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb24-302"><a href="#cb24-302" aria-hidden="true" tabindex="-1"></a><span class="fu">### R</span></span>
<span id="cb24-305"><a href="#cb24-305" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb24-306"><a href="#cb24-306" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb24-307"><a href="#cb24-307" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4, <span class="at">quietly=</span><span class="cn">TRUE</span>)</span>
<span id="cb24-308"><a href="#cb24-308" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb24-309"><a href="#cb24-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-310"><a href="#cb24-310" aria-hidden="true" tabindex="-1"></a><span class="co"># random intercepts model</span></span>
<span id="cb24-311"><a href="#cb24-311" aria-hidden="true" tabindex="-1"></a>model_ri <span class="ot">&lt;-</span> <span class="fu">lmer</span>(</span>
<span id="cb24-312"><a href="#cb24-312" aria-hidden="true" tabindex="-1"></a>    yield <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> soil_pH <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>farm_id),</span>
<span id="cb24-313"><a href="#cb24-313" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> field_data,</span>
<span id="cb24-314"><a href="#cb24-314" aria-hidden="true" tabindex="-1"></a>    <span class="at">REML =</span> <span class="cn">TRUE</span></span>
<span id="cb24-315"><a href="#cb24-315" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-316"><a href="#cb24-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-317"><a href="#cb24-317" aria-hidden="true" tabindex="-1"></a><span class="co"># this shows the model summary</span></span>
<span id="cb24-318"><a href="#cb24-318" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_ri)</span>
<span id="cb24-319"><a href="#cb24-319" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-320"><a href="#cb24-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-321"><a href="#cb24-321" aria-hidden="true" tabindex="-1"></a><span class="fu">### Julia</span></span>
<span id="cb24-324"><a href="#cb24-324" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-325"><a href="#cb24-325" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: false</span></span>
<span id="cb24-326"><a href="#cb24-326" aria-hidden="true" tabindex="-1"></a><span class="in">using MixedModels, StatsBase, StatsModels</span></span>
<span id="cb24-327"><a href="#cb24-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-328"><a href="#cb24-328" aria-hidden="true" tabindex="-1"></a><span class="in"># random intercepts model (structure essentially identical)</span></span>
<span id="cb24-329"><a href="#cb24-329" aria-hidden="true" tabindex="-1"></a><span class="in">model_ri = fit(</span></span>
<span id="cb24-330"><a href="#cb24-330" aria-hidden="true" tabindex="-1"></a><span class="in">    MixedModel,</span></span>
<span id="cb24-331"><a href="#cb24-331" aria-hidden="true" tabindex="-1"></a><span class="in">    @formula(yield ~ 1 + soil_pH + (1 | farm_id)),</span></span>
<span id="cb24-332"><a href="#cb24-332" aria-hidden="true" tabindex="-1"></a><span class="in">    field_data,</span></span>
<span id="cb24-333"><a href="#cb24-333" aria-hidden="true" tabindex="-1"></a><span class="in">    REML=true</span></span>
<span id="cb24-334"><a href="#cb24-334" aria-hidden="true" tabindex="-1"></a><span class="in">) # model summary displayed automatically</span></span>
<span id="cb24-335"><a href="#cb24-335" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-336"><a href="#cb24-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-337"><a href="#cb24-337" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-338"><a href="#cb24-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-339"><a href="#cb24-339" aria-hidden="true" tabindex="-1"></a>Ok so the model summaries both provide some key pieces of interformation. Perhaps most importantly, and what most people want to see right away is the population-level intercept and the effect of soil pH on crop yield (under the "Fixed Effects" header for R and the "Fixed-effects parameters" header for Julia). As a reminder, these two terms essentially refer to (a) the (nonsensical but instructive) estimated values of yeild should soil pH be 0, and (b) coefficient or slope that tells us what the per-unit change in yield is from a per-unit change in soil pH. The random effects section quantifies the variation attributable to differences between farms (the between-farm variance) and the residual variation within farms (the within-farm variance). These variance components allow us to partition the total variation in crop yield into systematic farm-level differences and plot-level residual variation.</span>
<span id="cb24-340"><a href="#cb24-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-341"><a href="#cb24-341" aria-hidden="true" tabindex="-1"></a>The ratio of these variance components is informative. A large farm-level variance relative to the residual variance indicates substantial heterogeneity between farms, justifying our decision to use a mixed-effects model rather than ordinary least squares regression. We can calculate the intraclass correlation coefficient to quantify the proportion of total variance attributable to farm-level differences.</span>
<span id="cb24-342"><a href="#cb24-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-343"><a href="#cb24-343" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb24-344"><a href="#cb24-344" aria-hidden="true" tabindex="-1"></a><span class="fu">### R</span></span>
<span id="cb24-347"><a href="#cb24-347" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb24-348"><a href="#cb24-348" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb24-349"><a href="#cb24-349" aria-hidden="true" tabindex="-1"></a><span class="co"># get out the variance components</span></span>
<span id="cb24-350"><a href="#cb24-350" aria-hidden="true" tabindex="-1"></a>var_components <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">VarCorr</span>(model_ri))</span>
<span id="cb24-351"><a href="#cb24-351" aria-hidden="true" tabindex="-1"></a>farm_var <span class="ot">&lt;-</span> var_components<span class="sc">$</span>vcov[<span class="dv">1</span>]</span>
<span id="cb24-352"><a href="#cb24-352" aria-hidden="true" tabindex="-1"></a>residual_var <span class="ot">&lt;-</span> var_components<span class="sc">$</span>vcov[<span class="dv">2</span>]</span>
<span id="cb24-353"><a href="#cb24-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-354"><a href="#cb24-354" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate icc manually</span></span>
<span id="cb24-355"><a href="#cb24-355" aria-hidden="true" tabindex="-1"></a>icc <span class="ot">&lt;-</span> farm_var <span class="sc">/</span> (farm_var <span class="sc">+</span> residual_var)</span>
<span id="cb24-356"><a href="#cb24-356" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Intraclass Correlation Coefficient:"</span>, <span class="fu">round</span>(icc, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb24-357"><a href="#cb24-357" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-358"><a href="#cb24-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-359"><a href="#cb24-359" aria-hidden="true" tabindex="-1"></a><span class="fu">### Julia</span></span>
<span id="cb24-362"><a href="#cb24-362" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-363"><a href="#cb24-363" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: false</span></span>
<span id="cb24-364"><a href="#cb24-364" aria-hidden="true" tabindex="-1"></a><span class="in"># get out the variance components</span></span>
<span id="cb24-365"><a href="#cb24-365" aria-hidden="true" tabindex="-1"></a><span class="in">vc = VarCorr(model_ri);</span></span>
<span id="cb24-366"><a href="#cb24-366" aria-hidden="true" tabindex="-1"></a><span class="in">farm_var = vc.œÉœÅ.farm_id.œÉ[1]^2;</span></span>
<span id="cb24-367"><a href="#cb24-367" aria-hidden="true" tabindex="-1"></a><span class="in">residual_var = vc.s^2;</span></span>
<span id="cb24-368"><a href="#cb24-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-369"><a href="#cb24-369" aria-hidden="true" tabindex="-1"></a><span class="in"># calculate icc manually</span></span>
<span id="cb24-370"><a href="#cb24-370" aria-hidden="true" tabindex="-1"></a><span class="in">icc = farm_var / (farm_var + residual_var);</span></span>
<span id="cb24-371"><a href="#cb24-371" aria-hidden="true" tabindex="-1"></a><span class="in">println("Intraclass Correlation Coefficient: ", round(icc, digits=3))</span></span>
<span id="cb24-372"><a href="#cb24-372" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-373"><a href="#cb24-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-374"><a href="#cb24-374" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-375"><a href="#cb24-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-376"><a href="#cb24-376" aria-hidden="true" tabindex="-1"></a>That's a pretty high value!</span>
<span id="cb24-377"><a href="#cb24-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-378"><a href="#cb24-378" aria-hidden="true" tabindex="-1"></a><span class="fu">### Assumption Checking</span></span>
<span id="cb24-379"><a href="#cb24-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-380"><a href="#cb24-380" aria-hidden="true" tabindex="-1"></a>Great, the models are fit, and we can interpret our results. Before we do so however, we need to verify the assumptions underlying our inferences. As discussed earlier, several assumptions must hold for our model to provide valid estimates and appropriate uncertainty quantification.</span>
<span id="cb24-381"><a href="#cb24-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-382"><a href="#cb24-382" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Residual Diagnostics</span></span>
<span id="cb24-383"><a href="#cb24-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-384"><a href="#cb24-384" aria-hidden="true" tabindex="-1"></a>We begin by examining the residuals for evidence of normality and homoscedasticity. The residuals should be approximately normally distributed and should exhibit constant variance across the range of fitted values.</span>
<span id="cb24-385"><a href="#cb24-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-386"><a href="#cb24-386" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb24-387"><a href="#cb24-387" aria-hidden="true" tabindex="-1"></a><span class="fu">### R</span></span>
<span id="cb24-390"><a href="#cb24-390" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb24-391"><a href="#cb24-391" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb24-392"><a href="#cb24-392" aria-hidden="true" tabindex="-1"></a><span class="co"># residuals and fitted values</span></span>
<span id="cb24-393"><a href="#cb24-393" aria-hidden="true" tabindex="-1"></a>field_data<span class="sc">$</span>residuals <span class="ot">&lt;-</span> <span class="fu">residuals</span>(model_ri)</span>
<span id="cb24-394"><a href="#cb24-394" aria-hidden="true" tabindex="-1"></a>field_data<span class="sc">$</span>fitted <span class="ot">&lt;-</span> <span class="fu">fitted</span>(model_ri)</span>
<span id="cb24-395"><a href="#cb24-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-396"><a href="#cb24-396" aria-hidden="true" tabindex="-1"></a><span class="co"># diagnostic plots</span></span>
<span id="cb24-397"><a href="#cb24-397" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb24-398"><a href="#cb24-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-399"><a href="#cb24-399" aria-hidden="true" tabindex="-1"></a><span class="co"># Q-Q plot for normality of residuals</span></span>
<span id="cb24-400"><a href="#cb24-400" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(field_data<span class="sc">$</span>residuals, <span class="at">main =</span> <span class="st">"Q-Q Plot of Residuals"</span>)</span>
<span id="cb24-401"><a href="#cb24-401" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(field_data<span class="sc">$</span>residuals, <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb24-402"><a href="#cb24-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-403"><a href="#cb24-403" aria-hidden="true" tabindex="-1"></a><span class="co"># homoscedasticity check</span></span>
<span id="cb24-404"><a href="#cb24-404" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(field_data<span class="sc">$</span>fitted, field_data<span class="sc">$</span>residuals,</span>
<span id="cb24-405"><a href="#cb24-405" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Fitted Values"</span>, <span class="at">ylab =</span> <span class="st">"Residuals"</span>,</span>
<span id="cb24-406"><a href="#cb24-406" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Residuals vs Fitted Values"</span>)</span>
<span id="cb24-407"><a href="#cb24-407" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb24-408"><a href="#cb24-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-409"><a href="#cb24-409" aria-hidden="true" tabindex="-1"></a><span class="co"># residuals</span></span>
<span id="cb24-410"><a href="#cb24-410" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(field_data<span class="sc">$</span>residuals, <span class="at">breaks =</span> <span class="dv">20</span>, </span>
<span id="cb24-411"><a href="#cb24-411" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Distribution of Residuals"</span>,</span>
<span id="cb24-412"><a href="#cb24-412" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Residuals"</span>)</span>
<span id="cb24-413"><a href="#cb24-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-414"><a href="#cb24-414" aria-hidden="true" tabindex="-1"></a><span class="co"># residuals vs predictor</span></span>
<span id="cb24-415"><a href="#cb24-415" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(field_data<span class="sc">$</span>soil_pH, field_data<span class="sc">$</span>residuals,</span>
<span id="cb24-416"><a href="#cb24-416" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Soil pH"</span>, <span class="at">ylab =</span> <span class="st">"Residuals"</span>,</span>
<span id="cb24-417"><a href="#cb24-417" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Residuals vs Soil pH"</span>)</span>
<span id="cb24-418"><a href="#cb24-418" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb24-419"><a href="#cb24-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-420"><a href="#cb24-420" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb24-421"><a href="#cb24-421" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-422"><a href="#cb24-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-423"><a href="#cb24-423" aria-hidden="true" tabindex="-1"></a><span class="fu">### Julia</span></span>
<span id="cb24-426"><a href="#cb24-426" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-427"><a href="#cb24-427" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: false</span></span>
<span id="cb24-428"><a href="#cb24-428" aria-hidden="true" tabindex="-1"></a><span class="in">using Plots, Distributions, StatsPlots</span></span>
<span id="cb24-429"><a href="#cb24-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-430"><a href="#cb24-430" aria-hidden="true" tabindex="-1"></a><span class="in"># extract residuals and fitted values</span></span>
<span id="cb24-431"><a href="#cb24-431" aria-hidden="true" tabindex="-1"></a><span class="in">field_data.residuals = residuals(model_ri);</span></span>
<span id="cb24-432"><a href="#cb24-432" aria-hidden="true" tabindex="-1"></a><span class="in">field_data.fitted = fitted(model_ri);</span></span>
<span id="cb24-433"><a href="#cb24-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-434"><a href="#cb24-434" aria-hidden="true" tabindex="-1"></a><span class="in"># Q-Q plot of residuals</span></span>
<span id="cb24-435"><a href="#cb24-435" aria-hidden="true" tabindex="-1"></a><span class="in">p1 = plot(qqplot(Normal, field_data.residuals),</span></span>
<span id="cb24-436"><a href="#cb24-436" aria-hidden="true" tabindex="-1"></a><span class="in">    xlabel="Theoretical Quantiles",</span></span>
<span id="cb24-437"><a href="#cb24-437" aria-hidden="true" tabindex="-1"></a><span class="in">    ylabel="Sample Quantiles",</span></span>
<span id="cb24-438"><a href="#cb24-438" aria-hidden="true" tabindex="-1"></a><span class="in">    title="Q-Q Plot of Residuals",</span></span>
<span id="cb24-439"><a href="#cb24-439" aria-hidden="true" tabindex="-1"></a><span class="in">    legend=false);</span></span>
<span id="cb24-440"><a href="#cb24-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-441"><a href="#cb24-441" aria-hidden="true" tabindex="-1"></a><span class="in"># homoscedasticity </span></span>
<span id="cb24-442"><a href="#cb24-442" aria-hidden="true" tabindex="-1"></a><span class="in">p2 = scatter(field_data.fitted, field_data.residuals,</span></span>
<span id="cb24-443"><a href="#cb24-443" aria-hidden="true" tabindex="-1"></a><span class="in">    xlabel="Fitted Values",</span></span>
<span id="cb24-444"><a href="#cb24-444" aria-hidden="true" tabindex="-1"></a><span class="in">    ylabel="Residuals",</span></span>
<span id="cb24-445"><a href="#cb24-445" aria-hidden="true" tabindex="-1"></a><span class="in">    title="Residuals vs Fitted Values",</span></span>
<span id="cb24-446"><a href="#cb24-446" aria-hidden="true" tabindex="-1"></a><span class="in">    legend=false,</span></span>
<span id="cb24-447"><a href="#cb24-447" aria-hidden="true" tabindex="-1"></a><span class="in">    alpha=0.6);</span></span>
<span id="cb24-448"><a href="#cb24-448" aria-hidden="true" tabindex="-1"></a><span class="in">hline!([0], color=:red, linestyle=:dash);</span></span>
<span id="cb24-449"><a href="#cb24-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-450"><a href="#cb24-450" aria-hidden="true" tabindex="-1"></a><span class="in"># hist of residuals</span></span>
<span id="cb24-451"><a href="#cb24-451" aria-hidden="true" tabindex="-1"></a><span class="in">p3 = histogram(field_data.residuals,</span></span>
<span id="cb24-452"><a href="#cb24-452" aria-hidden="true" tabindex="-1"></a><span class="in">    xlabel="Residuals",</span></span>
<span id="cb24-453"><a href="#cb24-453" aria-hidden="true" tabindex="-1"></a><span class="in">    ylabel="Frequency",</span></span>
<span id="cb24-454"><a href="#cb24-454" aria-hidden="true" tabindex="-1"></a><span class="in">    title="Distribution of Residuals",</span></span>
<span id="cb24-455"><a href="#cb24-455" aria-hidden="true" tabindex="-1"></a><span class="in">    legend=false,</span></span>
<span id="cb24-456"><a href="#cb24-456" aria-hidden="true" tabindex="-1"></a><span class="in">    bins=20);</span></span>
<span id="cb24-457"><a href="#cb24-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-458"><a href="#cb24-458" aria-hidden="true" tabindex="-1"></a><span class="in"># residuals vs predictor</span></span>
<span id="cb24-459"><a href="#cb24-459" aria-hidden="true" tabindex="-1"></a><span class="in">p4 = scatter(field_data.soil_pH, field_data.residuals,</span></span>
<span id="cb24-460"><a href="#cb24-460" aria-hidden="true" tabindex="-1"></a><span class="in">    xlabel="Soil pH",</span></span>
<span id="cb24-461"><a href="#cb24-461" aria-hidden="true" tabindex="-1"></a><span class="in">    ylabel="Residuals",</span></span>
<span id="cb24-462"><a href="#cb24-462" aria-hidden="true" tabindex="-1"></a><span class="in">    title="Residuals vs Soil pH",</span></span>
<span id="cb24-463"><a href="#cb24-463" aria-hidden="true" tabindex="-1"></a><span class="in">    legend=false,</span></span>
<span id="cb24-464"><a href="#cb24-464" aria-hidden="true" tabindex="-1"></a><span class="in">    alpha=0.6);</span></span>
<span id="cb24-465"><a href="#cb24-465" aria-hidden="true" tabindex="-1"></a><span class="in">hline!([0], color=:red, linestyle=:dash);</span></span>
<span id="cb24-466"><a href="#cb24-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-467"><a href="#cb24-467" aria-hidden="true" tabindex="-1"></a><span class="in">plot!(p1, p2, p3, p4, layout=(2, 2), size=(1100, 900))</span></span>
<span id="cb24-468"><a href="#cb24-468" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-469"><a href="#cb24-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-470"><a href="#cb24-470" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-471"><a href="#cb24-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-472"><a href="#cb24-472" aria-hidden="true" tabindex="-1"></a>The Q-Q plot allows us to assess whether the residuals follow a normal distribution. Points should fall approximately along the diagonal line, with systematic departures indicating non-normality. The residuals versus fitted values plot assesses homoscedasticity. We look for a random scatter of points around zero with no systematic patterns such as funneling or curvature. The residuals versus predictor plot serves a similar purpose, checking whether the variance changes systematically with soil pH. All of these look quite good. And reassuringly, we can check our outputs from both languages (R and Julia) and see the results thus far are the same!</span>
<span id="cb24-473"><a href="#cb24-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-474"><a href="#cb24-474" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb24-475"><a href="#cb24-475" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interpreting Residual Plots</span></span>
<span id="cb24-476"><a href="#cb24-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-477"><a href="#cb24-477" aria-hidden="true" tabindex="-1"></a>When examining residual plots, we are looking for the absence of patterns rather than the presence of specific features. A good residual plot shows points scattered randomly around zero with no trends, curves, or changes in spread. The reason for this is that patterns in these plots indicate violations of model assumptions that may require remedial action such as transformations or different model specifications. If you can't see anything interesting, the plots pass the check. </span>
<span id="cb24-478"><a href="#cb24-478" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-479"><a href="#cb24-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-480"><a href="#cb24-480" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Random Effects Diagnostics</span></span>
<span id="cb24-481"><a href="#cb24-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-482"><a href="#cb24-482" aria-hidden="true" tabindex="-1"></a>We must also verify that the random intercepts are approximately normally distributed. Let's extract the best linear unbiased predictors (BLUPs) or conditional modes for each farm and examine their distribution.</span>
<span id="cb24-483"><a href="#cb24-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-484"><a href="#cb24-484" aria-hidden="true" tabindex="-1"></a>:::{.callout-imp}</span>
<span id="cb24-485"><a href="#cb24-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-486"><a href="#cb24-486" aria-hidden="true" tabindex="-1"></a>One thing to note is that the number of levels we have for our random effect is small, since this is an example dataset. It's generally a rule of thumb that one should have **minimum** five levels (which is what we do) to justify a random effect. Below five levels *can* be possible if one isn't interested in making inference about the random effect itself, but five is the bare minimum, typically.</span>
<span id="cb24-487"><a href="#cb24-487" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-488"><a href="#cb24-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-489"><a href="#cb24-489" aria-hidden="true" tabindex="-1"></a>Since we have a very small number of levels in our random effect, we can't do something like a <span class="co">[</span><span class="ot">Shapiro-Wilk test</span><span class="co">](https://en.wikipedia.org/wiki/Shapiro%E2%80%93Wilk_test)</span> to check for normality, and we have to rely on the Q-Q plot, even though that as well is a challenge to assess with such few levels. In this case, we're looking for large, obvious deviations from our straight line. </span>
<span id="cb24-490"><a href="#cb24-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-491"><a href="#cb24-491" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb24-492"><a href="#cb24-492" aria-hidden="true" tabindex="-1"></a><span class="fu">### R</span></span>
<span id="cb24-495"><a href="#cb24-495" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb24-496"><a href="#cb24-496" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb24-497"><a href="#cb24-497" aria-hidden="true" tabindex="-1"></a><span class="co"># get random effects</span></span>
<span id="cb24-498"><a href="#cb24-498" aria-hidden="true" tabindex="-1"></a>random_effects <span class="ot">&lt;-</span> <span class="fu">ranef</span>(model_ri)<span class="sc">$</span>farm_id</span>
<span id="cb24-499"><a href="#cb24-499" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(random_effects) <span class="ot">&lt;-</span> <span class="st">"intercept"</span></span>
<span id="cb24-500"><a href="#cb24-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-501"><a href="#cb24-501" aria-hidden="true" tabindex="-1"></a><span class="co"># Q-Q plot on random effects</span></span>
<span id="cb24-502"><a href="#cb24-502" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb24-503"><a href="#cb24-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-504"><a href="#cb24-504" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(random_effects<span class="sc">$</span>intercept, </span>
<span id="cb24-505"><a href="#cb24-505" aria-hidden="true" tabindex="-1"></a>       <span class="at">main =</span> <span class="st">"Q-Q Plot of Random Intercepts"</span>)</span>
<span id="cb24-506"><a href="#cb24-506" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(random_effects<span class="sc">$</span>intercept, <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb24-507"><a href="#cb24-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-508"><a href="#cb24-508" aria-hidden="true" tabindex="-1"></a><span class="co"># hist of random effects</span></span>
<span id="cb24-509"><a href="#cb24-509" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(random_effects<span class="sc">$</span>intercept, <span class="at">breaks =</span> <span class="dv">10</span>,</span>
<span id="cb24-510"><a href="#cb24-510" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Distribution of Random Intercepts"</span>,</span>
<span id="cb24-511"><a href="#cb24-511" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Random Intercept"</span>)</span>
<span id="cb24-512"><a href="#cb24-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-513"><a href="#cb24-513" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb24-514"><a href="#cb24-514" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-515"><a href="#cb24-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-516"><a href="#cb24-516" aria-hidden="true" tabindex="-1"></a><span class="fu">### Julia</span></span>
<span id="cb24-519"><a href="#cb24-519" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-520"><a href="#cb24-520" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: false</span></span>
<span id="cb24-521"><a href="#cb24-521" aria-hidden="true" tabindex="-1"></a><span class="in"># extract via ranef but then turn from Vector{Matrix{Float64}} to just a flat</span></span>
<span id="cb24-522"><a href="#cb24-522" aria-hidden="true" tabindex="-1"></a><span class="in"># vector for easy plotting</span></span>
<span id="cb24-523"><a href="#cb24-523" aria-hidden="true" tabindex="-1"></a><span class="in">random_effects = vec(reduce(vcat, ranef(model_ri)));</span></span>
<span id="cb24-524"><a href="#cb24-524" aria-hidden="true" tabindex="-1"></a><span class="in"># Q-Q plot for random effects</span></span>
<span id="cb24-525"><a href="#cb24-525" aria-hidden="true" tabindex="-1"></a><span class="in">p1 = plot(qqplot(Normal, random_effects),</span></span>
<span id="cb24-526"><a href="#cb24-526" aria-hidden="true" tabindex="-1"></a><span class="in">    xlabel="Theoretical Quantiles",</span></span>
<span id="cb24-527"><a href="#cb24-527" aria-hidden="true" tabindex="-1"></a><span class="in">    ylabel="Sample Quantiles",</span></span>
<span id="cb24-528"><a href="#cb24-528" aria-hidden="true" tabindex="-1"></a><span class="in">    title="Q-Q Plot of Random Intercepts",</span></span>
<span id="cb24-529"><a href="#cb24-529" aria-hidden="true" tabindex="-1"></a><span class="in">    legend=false);</span></span>
<span id="cb24-530"><a href="#cb24-530" aria-hidden="true" tabindex="-1"></a><span class="in"># hist of random effects</span></span>
<span id="cb24-531"><a href="#cb24-531" aria-hidden="true" tabindex="-1"></a><span class="in">p2 = histogram(random_effects,</span></span>
<span id="cb24-532"><a href="#cb24-532" aria-hidden="true" tabindex="-1"></a><span class="in">    xlabel="Random Intercept",</span></span>
<span id="cb24-533"><a href="#cb24-533" aria-hidden="true" tabindex="-1"></a><span class="in">    ylabel="Frequency",</span></span>
<span id="cb24-534"><a href="#cb24-534" aria-hidden="true" tabindex="-1"></a><span class="in">    title="Distribution of Random Intercepts",</span></span>
<span id="cb24-535"><a href="#cb24-535" aria-hidden="true" tabindex="-1"></a><span class="in">    legend=false,</span></span>
<span id="cb24-536"><a href="#cb24-536" aria-hidden="true" tabindex="-1"></a><span class="in">    bins=10);</span></span>
<span id="cb24-537"><a href="#cb24-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-538"><a href="#cb24-538" aria-hidden="true" tabindex="-1"></a><span class="in">plot(p1, p2, layout=(1, 2), size=(800, 350))</span></span>
<span id="cb24-539"><a href="#cb24-539" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-540"><a href="#cb24-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-541"><a href="#cb24-541" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-542"><a href="#cb24-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-543"><a href="#cb24-543" aria-hidden="true" tabindex="-1"></a>The distribution of random intercepts reveals whether our assumption of normally distributed farm effects is reasonable. Substantial departures from normality may indicate the presence of outlying farms or suggest that the random effects structure requires modification.</span>
<span id="cb24-544"><a href="#cb24-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-545"><a href="#cb24-545" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualizing the Fitted Model</span></span>
<span id="cb24-546"><a href="#cb24-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-547"><a href="#cb24-547" aria-hidden="true" tabindex="-1"></a>Having verified that our model assumptions are reasonably satisfied, we can proceed to visualize the fitted relationships. These visualizations serve both to communicate our findings and to provide a final informal check of model adequacy. Importantly, this will involve us calculating our model **predictions**. Our model predictions will allow us to look at how our model creates a smooth relationship between our variables of interest. </span>
<span id="cb24-548"><a href="#cb24-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-549"><a href="#cb24-549" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb24-550"><a href="#cb24-550" aria-hidden="true" tabindex="-1"></a><span class="fu">### R</span></span>
<span id="cb24-553"><a href="#cb24-553" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb24-554"><a href="#cb24-554" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb24-555"><a href="#cb24-555" aria-hidden="true" tabindex="-1"></a><span class="co"># get a sequence of pH values for prediction</span></span>
<span id="cb24-556"><a href="#cb24-556" aria-hidden="true" tabindex="-1"></a>ph_range <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(field_data<span class="sc">$</span>soil_pH), </span>
<span id="cb24-557"><a href="#cb24-557" aria-hidden="true" tabindex="-1"></a>                <span class="fu">max</span>(field_data<span class="sc">$</span>soil_pH), </span>
<span id="cb24-558"><a href="#cb24-558" aria-hidden="true" tabindex="-1"></a>                <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb24-559"><a href="#cb24-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-560"><a href="#cb24-560" aria-hidden="true" tabindex="-1"></a><span class="co"># Population-level (fixed effects) prediction</span></span>
<span id="cb24-561"><a href="#cb24-561" aria-hidden="true" tabindex="-1"></a>pop_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_ri, </span>
<span id="cb24-562"><a href="#cb24-562" aria-hidden="true" tabindex="-1"></a>                    <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">soil_pH =</span> ph_range),</span>
<span id="cb24-563"><a href="#cb24-563" aria-hidden="true" tabindex="-1"></a>                    <span class="at">re.form =</span> <span class="cn">NA</span>)</span>
<span id="cb24-564"><a href="#cb24-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-565"><a href="#cb24-565" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb24-566"><a href="#cb24-566" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(field_data, <span class="fu">aes</span>(<span class="at">x =</span> soil_pH, <span class="at">y =</span> yield)) <span class="sc">+</span></span>
<span id="cb24-567"><a href="#cb24-567" aria-hidden="true" tabindex="-1"></a>    <span class="co"># put the individual farms</span></span>
<span id="cb24-568"><a href="#cb24-568" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">factor</span>(farm_id)), <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb24-569"><a href="#cb24-569" aria-hidden="true" tabindex="-1"></a>    <span class="co"># now farm-specific lines</span></span>
<span id="cb24-570"><a href="#cb24-570" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> fitted, <span class="at">group =</span> farm_id, <span class="at">color =</span> <span class="fu">factor</span>(farm_id)),</span>
<span id="cb24-571"><a href="#cb24-571" aria-hidden="true" tabindex="-1"></a>              <span class="at">linewidth =</span> <span class="fl">0.8</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb24-572"><a href="#cb24-572" aria-hidden="true" tabindex="-1"></a>    <span class="co"># now the trend overall</span></span>
<span id="cb24-573"><a href="#cb24-573" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">soil_pH =</span> ph_range, <span class="at">yield =</span> pop_pred),</span>
<span id="cb24-574"><a href="#cb24-574" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> soil_pH, <span class="at">y =</span> yield),</span>
<span id="cb24-575"><a href="#cb24-575" aria-hidden="true" tabindex="-1"></a>              <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb24-576"><a href="#cb24-576" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Soil pH"</span>,</span>
<span id="cb24-577"><a href="#cb24-577" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Crop Yield (kg/ha)"</span>,</span>
<span id="cb24-578"><a href="#cb24-578" aria-hidden="true" tabindex="-1"></a>         <span class="at">title =</span> <span class="st">"Random Intercepts Model: Crop Yield vs Soil pH"</span>,</span>
<span id="cb24-579"><a href="#cb24-579" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="st">"Dashed line: population average; Colored lines: farm-specific predictions"</span>,</span>
<span id="cb24-580"><a href="#cb24-580" aria-hidden="true" tabindex="-1"></a>         <span class="at">color =</span> <span class="st">"Farm"</span>) <span class="sc">+</span></span>
<span id="cb24-581"><a href="#cb24-581" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb24-582"><a href="#cb24-582" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb24-583"><a href="#cb24-583" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-584"><a href="#cb24-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-585"><a href="#cb24-585" aria-hidden="true" tabindex="-1"></a><span class="fu">### Julia</span></span>
<span id="cb24-588"><a href="#cb24-588" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-589"><a href="#cb24-589" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: false</span></span>
<span id="cb24-590"><a href="#cb24-590" aria-hidden="true" tabindex="-1"></a><span class="in"># get a sequence of pH values for prediction</span></span>
<span id="cb24-591"><a href="#cb24-591" aria-hidden="true" tabindex="-1"></a><span class="in">ph_range = collect(range(minimum(field_data.soil_pH),</span></span>
<span id="cb24-592"><a href="#cb24-592" aria-hidden="true" tabindex="-1"></a><span class="in">    maximum(field_data.soil_pH),</span></span>
<span id="cb24-593"><a href="#cb24-593" aria-hidden="true" tabindex="-1"></a><span class="in">    length=100));</span></span>
<span id="cb24-594"><a href="#cb24-594" aria-hidden="true" tabindex="-1"></a><span class="in"># Population-level (fixed effects) prediction</span></span>
<span id="cb24-595"><a href="#cb24-595" aria-hidden="true" tabindex="-1"></a><span class="in">pop_pred_data = DataFrame(</span></span>
<span id="cb24-596"><a href="#cb24-596" aria-hidden="true" tabindex="-1"></a><span class="in">    soil_pH=ph_range,</span></span>
<span id="cb24-597"><a href="#cb24-597" aria-hidden="true" tabindex="-1"></a><span class="in">    farm_id=repeat(["Farm_01"], Base.length(ph_range)),</span></span>
<span id="cb24-598"><a href="#cb24-598" aria-hidden="true" tabindex="-1"></a><span class="in">    yield=zeros(Base.length(ph_range))</span></span>
<span id="cb24-599"><a href="#cb24-599" aria-hidden="true" tabindex="-1"></a><span class="in">);</span></span>
<span id="cb24-600"><a href="#cb24-600" aria-hidden="true" tabindex="-1"></a><span class="in">pop_pred = predict(model_ri, pop_pred_data, new_re_levels=:population);</span></span>
<span id="cb24-601"><a href="#cb24-601" aria-hidden="true" tabindex="-1"></a><span class="in"># plot</span></span>
<span id="cb24-602"><a href="#cb24-602" aria-hidden="true" tabindex="-1"></a><span class="in">p = scatter(field_data.soil_pH, field_data.yield,</span></span>
<span id="cb24-603"><a href="#cb24-603" aria-hidden="true" tabindex="-1"></a><span class="in">    group=field_data.farm_id,</span></span>
<span id="cb24-604"><a href="#cb24-604" aria-hidden="true" tabindex="-1"></a><span class="in">    xlabel="Soil pH",</span></span>
<span id="cb24-605"><a href="#cb24-605" aria-hidden="true" tabindex="-1"></a><span class="in">    ylabel="Crop Yield (kg/ha)",</span></span>
<span id="cb24-606"><a href="#cb24-606" aria-hidden="true" tabindex="-1"></a><span class="in">    title="Random Intercepts Model: Crop Yield vs Soil pH",</span></span>
<span id="cb24-607"><a href="#cb24-607" aria-hidden="true" tabindex="-1"></a><span class="in">    alpha=0.6,</span></span>
<span id="cb24-608"><a href="#cb24-608" aria-hidden="true" tabindex="-1"></a><span class="in">    markersize=4,</span></span>
<span id="cb24-609"><a href="#cb24-609" aria-hidden="true" tabindex="-1"></a><span class="in">    legend=:outerright,</span></span>
<span id="cb24-610"><a href="#cb24-610" aria-hidden="true" tabindex="-1"></a><span class="in">    label=permutedims(unique(field_data.farm_id)));</span></span>
<span id="cb24-611"><a href="#cb24-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-612"><a href="#cb24-612" aria-hidden="true" tabindex="-1"></a><span class="in"># add farm-specific fitted lines</span></span>
<span id="cb24-613"><a href="#cb24-613" aria-hidden="true" tabindex="-1"></a><span class="in">for farm in unique(field_data.farm_id)</span></span>
<span id="cb24-614"><a href="#cb24-614" aria-hidden="true" tabindex="-1"></a><span class="in">    farm_data = field_data[field_data.farm_id.==farm, :]</span></span>
<span id="cb24-615"><a href="#cb24-615" aria-hidden="true" tabindex="-1"></a><span class="in">    plot!(farm_data.soil_pH, farm_data.fitted,</span></span>
<span id="cb24-616"><a href="#cb24-616" aria-hidden="true" tabindex="-1"></a><span class="in">        label="",</span></span>
<span id="cb24-617"><a href="#cb24-617" aria-hidden="true" tabindex="-1"></a><span class="in">        linewidth=2,</span></span>
<span id="cb24-618"><a href="#cb24-618" aria-hidden="true" tabindex="-1"></a><span class="in">        alpha=0.7)</span></span>
<span id="cb24-619"><a href="#cb24-619" aria-hidden="true" tabindex="-1"></a><span class="in">end</span></span>
<span id="cb24-620"><a href="#cb24-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-621"><a href="#cb24-621" aria-hidden="true" tabindex="-1"></a><span class="in"># add population-level trend finally</span></span>
<span id="cb24-622"><a href="#cb24-622" aria-hidden="true" tabindex="-1"></a><span class="in">plot!(ph_range, pop_pred,</span></span>
<span id="cb24-623"><a href="#cb24-623" aria-hidden="true" tabindex="-1"></a><span class="in">    color=:black,</span></span>
<span id="cb24-624"><a href="#cb24-624" aria-hidden="true" tabindex="-1"></a><span class="in">    linewidth=2,</span></span>
<span id="cb24-625"><a href="#cb24-625" aria-hidden="true" tabindex="-1"></a><span class="in">    linestyle=:dash,</span></span>
<span id="cb24-626"><a href="#cb24-626" aria-hidden="true" tabindex="-1"></a><span class="in">    label="Population Average",</span></span>
<span id="cb24-627"><a href="#cb24-627" aria-hidden="true" tabindex="-1"></a><span class="in">    size=(1100, 900))</span></span>
<span id="cb24-628"><a href="#cb24-628" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-629"><a href="#cb24-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-630"><a href="#cb24-630" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-631"><a href="#cb24-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-632"><a href="#cb24-632" aria-hidden="true" tabindex="-1"></a>This nice plot we've made here illustrates the essential structure of the random intercepts model. Each farm has its own fitted line, all sharing the same slope (the effect of soil pH) but with different intercepts reflecting farm-specific baseline productivity. The population-average line represents the expected relationship for a typical farm, averaged across all farm-level variation. The parallel nature of the farm-specific lines reflects our model assumption that the effect of soil pH does not vary across farms‚Äîan assumption we could relax if considering random *slopes* models.</span>
<span id="cb24-633"><a href="#cb24-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-634"><a href="#cb24-634" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb24-635"><a href="#cb24-635" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model Interpretation</span></span>
<span id="cb24-636"><a href="#cb24-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-637"><a href="#cb24-637" aria-hidden="true" tabindex="-1"></a>The fixed effect of soil pH represents the expected change in crop yield per unit increase in pH, averaged across all farms. The random intercepts capture farm-specific deviations from the population mean, representing unmeasured characteristics that make some farms systematically more or less productive than others. This decomposition allows us to make both farm-specific predictions (incorporating the farm's baseline productivity) and population-level inferences (describing the typical relationship between pH and yield).</span>
<span id="cb24-638"><a href="#cb24-638" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-639"><a href="#cb24-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-640"><a href="#cb24-640" aria-hidden="true" tabindex="-1"></a><span class="fu"># FAQs</span></span>
<span id="cb24-641"><a href="#cb24-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-642"><a href="#cb24-642" aria-hidden="true" tabindex="-1"></a><span class="fu">### *When should I use a mixed model instead of traditional regression?*</span></span>
<span id="cb24-643"><a href="#cb24-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-644"><a href="#cb24-644" aria-hidden="true" tabindex="-1"></a>Use mixed models when your data has a natural grouping or clustering structure and observations within groups are likely correlated. Examples include repeated measures on the same subjects, students within schools, or spatial clusters. You cannot just ignore this variation. If you ignore this structure, your standard errors will be wrong and your inferences invalid!</span>
<span id="cb24-645"><a href="#cb24-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-646"><a href="#cb24-646" aria-hidden="true" tabindex="-1"></a><span class="fu">### *I'm working in R/Julia and want to know more about some of the code I'm trying to use*</span></span>
<span id="cb24-647"><a href="#cb24-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-648"><a href="#cb24-648" aria-hidden="true" tabindex="-1"></a>You should check out the excellent documentation that exits for both resources. The <span class="in">`lme4`</span> package has the <span class="co">[</span><span class="ot">docs</span><span class="co">](https://cran.r-project.org/web/packages/lme4/lme4.pdf)</span> of course, but it also has a paper attached to it <span class="co">[</span><span class="ot">@Bates-FittingLinearLme4-2014f</span><span class="co">]</span> which also may be helpful. The Julia <span class="in">`MixedModels.jl`</span> <span class="co">[</span><span class="ot">docs</span><span class="co">](https://juliastats.org/MixedModels.jl/stable/)</span> maintained by @Alday-MixedModelsJl-2025v are excellent. </span>
<span id="cb24-649"><a href="#cb24-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-650"><a href="#cb24-650" aria-hidden="true" tabindex="-1"></a><span class="fu">### *How do I decide what to include as random effects?*</span></span>
<span id="cb24-651"><a href="#cb24-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-652"><a href="#cb24-652" aria-hidden="true" tabindex="-1"></a>An age old question! Often, depending on what kind of inference you want to make, the same effects could be considered either fixed OR random. Start by identifying the grouping structure in your data. Include random intercepts for grouping factors where you expect baseline differences across groups. Be parsimonious: more complex random effects structures require more data to estimate reliably. A common rule of thumb is to have at least 5-10 groups per random effect parameter.</span>
<span id="cb24-653"><a href="#cb24-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-654"><a href="#cb24-654" aria-hidden="true" tabindex="-1"></a><span class="fu">### *I have a random effect on my intercept, but I think that within my groups, the relationship between my fixed effect and my response will be different. What should I do?* </span></span>
<span id="cb24-655"><a href="#cb24-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-656"><a href="#cb24-656" aria-hidden="true" tabindex="-1"></a>You are no longer talking about a fixed effect! That, referencing @fig-modeltypes, you are now interested in a purely *random effects* model. Proceed with the fitting of the model the same way you would otherwise in most cases, after consulting a suitable text. </span>
<span id="cb24-657"><a href="#cb24-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-658"><a href="#cb24-658" aria-hidden="true" tabindex="-1"></a><span class="fu">### *What's the difference between ML and REML estimation?*</span></span>
<span id="cb24-659"><a href="#cb24-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-660"><a href="#cb24-660" aria-hidden="true" tabindex="-1"></a>REML (Restricted Maximum Likelihood) is generally preferred because it produces unbiased estimates of variance components. However, you can't use it for model comparison. Use ML when comparing models with different fixed effects structures using likelihood ratio tests, then refit the final model with REML. For comparing models with different random effects, either ML or REML is appropriate.</span>
<span id="cb24-661"><a href="#cb24-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-662"><a href="#cb24-662" aria-hidden="true" tabindex="-1"></a><span class="fu">### *What if I don't have normal data (e.g. binomial, count data, etc)?*</span></span>
<span id="cb24-663"><a href="#cb24-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-664"><a href="#cb24-664" aria-hidden="true" tabindex="-1"></a>Then you're looking for a generalized linear mixed-effects model (GLMM). The concepts underpining a GLMM are very similar with respect to the effects and the intuition, but require some extra care. Fitting them can be challenging, though many excellent resources exist to help you fit them out of the box. @Bolker-GeneralizedLinearEvolution-2009o is a very accessible introduction to the topic.</span>
<span id="cb24-665"><a href="#cb24-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-666"><a href="#cb24-666" aria-hidden="true" tabindex="-1"></a><span class="fu">### *How do I assess model fit for mixed models?*</span></span>
<span id="cb24-667"><a href="#cb24-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-668"><a href="#cb24-668" aria-hidden="true" tabindex="-1"></a>Unlike OLS regression, $R^2$ is more complex for mixed models. Use conditional $R^2$ (variance explained by fixed and random effects) and marginal $R^2$ (variance explained by fixed effects only). Information criteria (AIC, BIC) are useful for model comparison. For validation, consider cross-validation at the group level.</span>
<span id="cb24-669"><a href="#cb24-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-670"><a href="#cb24-670" aria-hidden="true" tabindex="-1"></a><span class="fu">### *Can I include both spatial and temporal correlation structures?*</span></span>
<span id="cb24-671"><a href="#cb24-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-672"><a href="#cb24-672" aria-hidden="true" tabindex="-1"></a>Yes, but this requires careful consideration. Packages like <span class="in">`nlme`</span> in R allow you to specify complex correlation structures within groups. However, computational demands increase substantially. For spatiotemporal data, consider whether the spatial correlation is adequately captured by random effects or whether you need explicit correlation structures.</span>
<span id="cb24-673"><a href="#cb24-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-674"><a href="#cb24-674" aria-hidden="true" tabindex="-1"></a><span class="fu"># References</span></span>
<span id="cb24-675"><a href="#cb24-675" aria-hidden="true" tabindex="-1"></a>::: {#refs}</span>
<span id="cb24-676"><a href="#cb24-676" aria-hidden="true" tabindex="-1"></a>::::</span>
<span id="cb24-677"><a href="#cb24-677" aria-hidden="true" tabindex="-1"></a>**Some Suggestions for Core Textbooks:**</span>
<span id="cb24-678"><a href="#cb24-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-679"><a href="#cb24-679" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Gelman, Andrew, and Jennifer Hill. *Data Analysis Using Regression and Multilevel/Hierarchical Models*. Cambridge University Press, 2006.</span>
<span id="cb24-680"><a href="#cb24-680" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Pinheiro, Jos√© C., and Douglas M. Bates. *Mixed-Effects Models in S and S-PLUS*. Springer, 2000.</span>
<span id="cb24-681"><a href="#cb24-681" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Fitzmaurice, Garrett M., Nan M. Laird, and James H. Ware. *Applied Longitudinal Analysis*. 2nd ed. Wiley, 2011.</span>
<span id="cb24-682"><a href="#cb24-682" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>McCulloch, Charles E., and Shayle R. Searle. *Generalized, Linear, and Mixed Models*. Wiley, 2001.</span>
<span id="cb24-683"><a href="#cb24-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-684"><a href="#cb24-684" aria-hidden="true" tabindex="-1"></a><span class="fu"># Appendix</span></span>
<span id="cb24-685"><a href="#cb24-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-686"><a href="#cb24-686" aria-hidden="true" tabindex="-1"></a><span class="fu">## Appendix A - REML {#sec-reml}</span></span>
<span id="cb24-687"><a href="#cb24-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-688"><a href="#cb24-688" aria-hidden="true" tabindex="-1"></a><span class="fu">### Restricted Maximum Likelihood Estimation</span></span>
<span id="cb24-689"><a href="#cb24-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-690"><a href="#cb24-690" aria-hidden="true" tabindex="-1"></a>In the preceding discussion of the formalism underlying linear mixed-effects models, we referenced the profiled log-likelihood and the estimation of the variance-component parameter $\theta$. We now examine more carefully the method by which these parameters are estimated, with particular attention to why the default approach in most modern software implementations is not ordinary maximum likelihood but rather restricted maximum likelihood, commonly abbreviated as REML.</span>
<span id="cb24-691"><a href="#cb24-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-692"><a href="#cb24-692" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Profiled Likelihood</span></span>
<span id="cb24-693"><a href="#cb24-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-694"><a href="#cb24-694" aria-hidden="true" tabindex="-1"></a>Before proceeding to REML, we must first understand what is meant by a "profiled" likelihood, as we referred to it above. When we fit a linear mixed-effects model, we are simultaneously estimating two types of parameters: the fixed effects $\beta$ and the variance components $\theta$. The full likelihood function depends on both sets of parameters. However, for any given value of $\theta$, we can analytically determine the value of $\beta$ that maximizes the likelihood. This process of maximizing over $\beta$ for each value of $\theta$ is called profiling, and it yields the profiled likelihood, which is a function of $\theta$ alone.</span>
<span id="cb24-695"><a href="#cb24-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-696"><a href="#cb24-696" aria-hidden="true" tabindex="-1"></a>The computational advantage of this approach is substantial. Rather than searching through the *entire* high-dimensional space of all possible combinations of $\beta$ and $\theta$, we reduce the problem to a search over the typically much lower-dimensional space of $\theta$ values. For each candidate value of $\theta$ we consider, we can immediately compute the corresponding optimal $\beta$. This profiled likelihood is what we actually optimize when fitting mixed-effects models, and the resulting estimate $\hat{\theta}$ then allows us to compute the corresponding $\hat{\beta}$.</span>
<span id="cb24-697"><a href="#cb24-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-698"><a href="#cb24-698" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Motivation for REML</span></span>
<span id="cb24-699"><a href="#cb24-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-700"><a href="#cb24-700" aria-hidden="true" tabindex="-1"></a>Maximum likelihood estimation, while possessing many desirable theoretical properties, has a well-known deficiency when applied to variance components: the estimates tend to be biased downward. This irritating bias arises because maximum likelihood does not properly account for the degrees of freedom lost in estimating the fixed effects. The problem is perhaps most familiar in the simpler context of estimating a population variance from a sample, where we divide by $n-1$ rather than $n$ to obtain an unbiased estimate. The correction factor $n-1$ accounts for the fact that we had to estimate the mean from the data rather than knowing it a priori. The maximum likelihood estimate would use $n$ in the denominator and would consequently underestimate the true variance.</span>
<span id="cb24-701"><a href="#cb24-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-702"><a href="#cb24-702" aria-hidden="true" tabindex="-1"></a>In mixed-effects models, this same phenomenon occurs but in a more complex form. When we estimate variance components using maximum likelihood, we are effectively using all $n$ observations without properly accounting for the $p$ degrees of freedom consumed by estimating the $p$ fixed effects in $\beta$. The result is that variance components, particularly the residual variance $\sigma^2$, tend to be underestimated. While this bias diminishes as the sample size grows large relative to the number of fixed effects, it can be consequential in finite samples, particularly when the number of fixed effects is substantial relative to the sample size.</span>
<span id="cb24-703"><a href="#cb24-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-704"><a href="#cb24-704" aria-hidden="true" tabindex="-1"></a>Restricted maximum likelihood addresses this problem by basing inference on a transformed version of the data that does not depend on the fixed effects $\beta$. Rather than maximizing the likelihood of the original data $\mathbf{y}$, REML maximizes the likelihood of $n-p$ error contrasts, which are linear combinations of the data chosen such that they contain no information about $\beta$. These contrasts can be thought of as generalized residuals that have had the fixed effects structure removed. By working with these contrasts rather than the raw data, REML properly accounts for the degrees of freedom used in estimating the fixed effects and produces less biased estimates of the variance components.</span>
<span id="cb24-705"><a href="#cb24-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-706"><a href="#cb24-706" aria-hidden="true" tabindex="-1"></a><span class="fu">### The REML Criterion</span></span>
<span id="cb24-707"><a href="#cb24-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-708"><a href="#cb24-708" aria-hidden="true" tabindex="-1"></a>Mathematically, the REML estimate of $\theta$ is obtained by maximizing the restricted log-likelihood, which, though abhorent to look at, can be written should one desire as</span>
<span id="cb24-709"><a href="#cb24-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-710"><a href="#cb24-710" aria-hidden="true" tabindex="-1"></a>\begin{equation}</span>
<span id="cb24-711"><a href="#cb24-711" aria-hidden="true" tabindex="-1"></a>\ell_R(\theta|\mathbf{y}) = </span>
<span id="cb24-712"><a href="#cb24-712" aria-hidden="true" tabindex="-1"></a>-\frac{1}{2}\left[\log|\Lambda_\theta^T\Lambda_\theta + \mathbf{I}| + </span>
<span id="cb24-713"><a href="#cb24-713" aria-hidden="true" tabindex="-1"></a>\log|\mathbf{X}^T\mathbf{X}| + (\mathbf{y} - </span>
<span id="cb24-714"><a href="#cb24-714" aria-hidden="true" tabindex="-1"></a>\mathbf{X}\hat{\beta}_\theta)^T(\Lambda_\theta^T\Lambda_\theta + </span>
<span id="cb24-715"><a href="#cb24-715" aria-hidden="true" tabindex="-1"></a>\sigma^2\mathbf{I})^{-1}(\mathbf{y} - \mathbf{X}\hat{\beta}_\theta)\right].</span>
<span id="cb24-716"><a href="#cb24-716" aria-hidden="true" tabindex="-1"></a>\end{equation}</span>
<span id="cb24-717"><a href="#cb24-717" aria-hidden="true" tabindex="-1"></a>If we can get over this equation's initial hideous appearance, we can see that almost all of the components are ones we've seen before. $\hat{\beta}_\theta$ denotes the conditional estimate of $\beta$ given $\theta$. The second term, $\log|\mathbf{X}^T\mathbf{X}|$, represents the penalty for having estimated the fixed effects, and it is this term that distinguishes REML from ordinary maximum likelihood. This penalty adjusts the likelihood to account for the uncertainty introduced by not knowing $\beta$ a priori.</span>
<span id="cb24-718"><a href="#cb24-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-719"><a href="#cb24-719" aria-hidden="true" tabindex="-1"></a>The optimization of this restricted log-likelihood proceeds similarly to that of the profiled log-likelihood described earlier. We search over values of $\theta$, and for each candidate value we can compute the corresponding estimates of all other quantities of interest. The computational machinery for REML is thus quite similar to that for maximum likelihood, differing primarily in the objective function being optimized.</span>
<span id="cb24-720"><a href="#cb24-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-721"><a href="#cb24-721" aria-hidden="true" tabindex="-1"></a><span class="fu">### REML versus Maximum Likelihood</span></span>
<span id="cb24-722"><a href="#cb24-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-723"><a href="#cb24-723" aria-hidden="true" tabindex="-1"></a>Given that REML provides less biased estimates of variance components, one might wonder why maximum likelihood retains any role at all?! The answer lies in model comparison, which we only touch on briefly here. The REML criterion cannot be used to compare models with different fixed effects structures. This restriction arises because different fixed effects specifications effectively involve different linear transformations of the data, and the REML likelihoods under these different transformations are not directly comparable. It would be analogous to comparing the likelihood of your original data with the likelihood of some transformed version of your data. In short, we recommend: </span>
<span id="cb24-724"><a href="#cb24-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-725"><a href="#cb24-725" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Using classical maximum likelihood if you want to do model comparison with fixed effects structures</span>
<span id="cb24-726"><a href="#cb24-726" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Once you've identified your best model, refit it with REML</span>
<span id="cb24-727"><a href="#cb24-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-728"><a href="#cb24-728" aria-hidden="true" tabindex="-1"></a>::: {.callout-caution collapse="true"}</span>
<span id="cb24-729"><a href="#cb24-729" aria-hidden="true" tabindex="-1"></a><span class="fu">## What do we mean by model comparison?</span></span>
<span id="cb24-730"><a href="#cb24-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-731"><a href="#cb24-731" aria-hidden="true" tabindex="-1"></a>This limitation has important practical implications. When you wish to conduct a likelihood ratio test or compare AIC values to decide whether to include or exclude a particular fixed effect, you must refit your models using maximum likelihood rather than REML. The models can then be compared on the basis of their ML log-likelihoods, and once you have selected your fixed effects structure, you can refit the final model using REML to obtain the best estimates of the variance components.</span>
<span id="cb24-732"><a href="#cb24-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-733"><a href="#cb24-733" aria-hidden="true" tabindex="-1"></a>REML remains perfectly suitable for comparing models with different random effects structures, provided the fixed effects remain constant. For example, if you are deciding whether to include random slopes in addition to random intercepts, you can fit both models with REML and compare them via likelihood ratio tests or information criteria. The fixed effects structure is the same in both models, so the REML likelihoods are comparable.</span>
<span id="cb24-734"><a href="#cb24-734" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-735"><a href="#cb24-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-736"><a href="#cb24-736" aria-hidden="true" tabindex="-1"></a>In summary, REML is the preferred estimation method for linear mixed-effects models when your primary interest is in obtaining accurate estimates of variance components and when you have already determined your fixed effects structure, which, in all of our examples herein, we will have done. Maximum likelihood remains necessary when you need to compare models that differ in their fixed effects. Most statistical software packages default to REML for precisely this reason, as it provides better finite-sample properties for the variance component estimates that are often of central interest in hierarchical data analysis.</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>